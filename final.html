<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NASDAQ 100 (NQ) Timing Breakdown & Market Behavior</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#5D5CDE',
            'primary-dark': '#4A49B8',
            'primary-light': '#7A79E6',
            'bg-light': '#FFFFFF',
            'bg-dark': '#181818',
            'green-custom': '#4CAF50',
            'yellow-custom': '#FFC107',
            'red-custom': '#F44336',
            'blue-custom': '#2196F3',
            'purple-custom': '#9C27B0',
            'indigo-custom': '#3F51B5',
            'gray-custom': '#607D8B',
          }
        }
      }
    }
  </script>
  <style>
    .progress-bar {
      transition: width 0.5s ease;
    }
    
    .phase-card {
      transition: all 0.3s ease;
    }
    
    .phase-card:hover {
      transform: translateY(-4px);
    }
    
    .timeline-dot {
      transition: all 0.3s ease;
    }
    
    .notification-badge {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .sound-wave {
      display: inline-block;
      height: 16px;
      width: 16px;
      position: relative;
    }
    
    .sound-wave span {
      position: absolute;
      bottom: 0;
      width: 2px;
      background: currentColor;
      transform-origin: bottom;
    }
    
    .sound-wave span:nth-child(1) {
      left: 0;
      height: 8px;
      animation: sound-wave 1s infinite ease-in-out;
    }
    
    .sound-wave span:nth-child(2) {
      left: 4px;
      height: 10px;
      animation: sound-wave 1.2s infinite ease-in-out;
    }
    
    .sound-wave span:nth-child(3) {
      left: 8px;
      height: 12px;
      animation: sound-wave 1.1s infinite ease-in-out;
    }
    
    .sound-wave span:nth-child(4) {
      left: 12px;
      height: 7px;
      animation: sound-wave 0.9s infinite ease-in-out;
    }
    
    @keyframes sound-wave {
      0%, 100% { transform: scaleY(1); }
      50% { transform: scaleY(0.5); }
    }
    
    /* Custom toggle switch */
    .toggle-checkbox:checked {
      right: 0;
      border-color: #5D5CDE;
    }
    
    .toggle-checkbox:checked + .toggle-label {
      background-color: #5D5CDE;
    }
    
    /* Tab styles */
    .tab {
      transition: all 0.3s ease;
    }
    
    .tab.active {
      border-color: #5D5CDE;
      color: #5D5CDE;
    }
    
    .dark .tab.active {
      border-color: #7A79E6;
      color: #7A79E6;
    }
    
    /* Sub-phase styles */
    .sub-phase {
      border-left: 2px solid #e5e7eb;
      transition: all 0.3s ease;
    }
    
    .dark .sub-phase {
      border-left: 2px solid #374151;
    }
    
    .sub-phase.active {
      border-left: 2px solid #5D5CDE;
    }
    
    .dark .sub-phase.active {
      border-left: 2px solid #7A79E6;
    }

    .emoji-icon {
      font-size: 1.3rem;
      line-height: 1;
      display: inline-block;
      vertical-align: middle;
      margin-right: 0.25rem;
    }

    /* Highlight the current time in the schedule */
    .schedule-row.active {
      background-color: rgba(93, 92, 222, 0.1);
    }
    
    .dark .schedule-row.active {
      background-color: rgba(122, 121, 230, 0.15);
    }
    
    /* Journal entry styles */
    .journal-entry {
      transition: all 0.3s ease;
      position: relative;
    }
    
    .journal-entry:hover {
      transform: translateY(-2px);
    }
    
    .journal-entry::before {
      content: '';
      position: absolute;
      left: -15px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: currentColor;
    }
    
    /* Calendar day styles */
    .calendar-day {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .calendar-day:hover:not(.selected):not(.has-entries) {
      background-color: rgba(93, 92, 222, 0.1);
    }
    
    .calendar-day.selected {
      background-color: #5D5CDE;
      color: white;
    }
    
    .dark .calendar-day.selected {
      background-color: #7A79E6;
    }
    
    .calendar-day.has-entries:not(.selected) {
      background-color: rgba(93, 92, 222, 0.2);
    }
    
    .dark .calendar-day.has-entries:not(.selected) {
      background-color: rgba(122, 121, 230, 0.2);
    }
    
    .calendar-day.today:not(.selected) {
      border: 2px solid #5D5CDE;
    }
    
    .dark .calendar-day.today:not(.selected) {
      border: 2px solid #7A79E6;
    }
    
    /* Journal image styles */
    .journal-image-container {
      position: relative;
      display: inline-block;
      margin-top: 8px;
      margin-bottom: 8px;
      max-width: 100%;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .journal-image {
      max-width: 100%;
      max-height: 300px;
      display: block;
    }
    
    .image-zoom-btn {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background-color: rgba(0,0,0,0.5);
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .image-zoom-btn:hover {
      background-color: rgba(0,0,0,0.7);
    }
    
    .image-fullscreen-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 2rem;
    }
    
    .image-fullscreen {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    
    .image-fullscreen-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      color: white;
      font-size: 2rem;
      cursor: pointer;
    }

    .fullscreen-thumbnail {
      width: 60px;
      height: 40px;
      object-fit: cover;
      border: 2px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.2s;
    }

    .fullscreen-thumbnail.active {
      border-color: white;
      opacity: 1;
    }
    
    /* Images preview container */
    .image-previews-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    
    .image-preview-item {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }
    
    .dark .image-preview-item {
      border-color: #374151;
    }
    
    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .remove-preview-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background-color: rgba(0,0,0,0.5);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 10px;
    }
    
    .remove-preview-btn:hover {
      background-color: rgba(0,0,0,0.7);
    }
    
    .journal-images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    
    .journal-images-grid .journal-image-container {
      margin: 0;
      width: 100%;
      height: 150px;
    }
    
    .journal-images-grid .journal-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      max-height: none;
    }
    
    /* Analytics styles */
    .analytics-card {
      transition: all 0.3s ease;
    }
    
    .analytics-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .indicator-badge {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }
    
    /* Search highlight */
    .highlight {
      background-color: rgba(255, 193, 7, 0.3);
      padding: 1px 2px;
      border-radius: 2px;
    }
    
    /* Tags styling */
    .tag {
      transition: all 0.2s ease;
    }
    
    .tag:hover {
      transform: translateY(-1px);
    }
    
    /* Journal entry highlight animation */
    @keyframes highlight-pulse {
      0% { box-shadow: 0 0 0 0 rgba(93, 92, 222, 0.4); }
      70% { box-shadow: 0 0 0 8px rgba(93, 92, 222, 0); }
      100% { box-shadow: 0 0 0 0 rgba(93, 92, 222, 0); }
    }
    
    .entry-highlight {
      animation: highlight-pulse 1.5s ease-out 1;
    }
    
    /* Custom date range picker */
    .daterange-picker {
      position: relative;
    }
    
    .daterange-menu {
      position: absolute;
      top: 100%;
      right: 0;
      z-index: 10;
      width: 280px;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .preset-btn.active {
      background-color: rgba(93, 92, 222, 0.2);
      color: #5D5CDE;
    }
    
    .dark .preset-btn.active {
      background-color: rgba(122, 121, 230, 0.2);
      color: #7A79E6;
    }
    
    /* Journal form in edit mode */
    .journal-form-container.edit-mode {
      border: 2px solid #5D5CDE;
    }
    
    .dark .journal-form-container.edit-mode {
      border: 2px solid #7A79E6;
    }
    
    .edit-mode-indicator {
      display: none;
      background-color: rgba(93, 92, 222, 0.1);
      border-left: 3px solid #5D5CDE;
      padding: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .dark .edit-mode-indicator {
      background-color: rgba(122, 121, 230, 0.15);
      border-left: 3px solid #7A79E6;
    }
    
    .edit-mode .edit-mode-indicator {
      display: block;
    }
    
    /* Action buttons for journal entries */
    .entry-actions {
      opacity: 0.7;
      transition: opacity 0.2s ease;
    }
    
    .journal-entry:hover .entry-actions {
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-bg-dark text-gray-900 dark:text-gray-100 transition-colors duration-200 min-h-screen">
  <!-- Main container -->
  <div class="container mx-auto px-4 py-6 max-w-6xl">
    <header class="mb-6">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold text-primary dark:text-primary-light mb-2">NASDAQ 100 (NQ) Timing Breakdown & Market Behavior</h1>
          <p class="text-gray-600 dark:text-gray-400">All times in Eastern Time (ET)</p>
        </div>
        <div class="flex items-center mt-4 md:mt-0 space-x-4">
          <button id="settings-btn" class="flex items-center text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light transition-colors">
            <i class="fas fa-cog mr-1"></i> Settings
          </button>
          <button id="notification-toggle" class="flex items-center text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light transition-colors relative">
            <i id="notification-icon" class="fas fa-bell mr-1"></i>
            <span id="notification-text">Notifications</span>
            <span id="notification-badge" class="hidden notification-badge absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">!</span>
          </button>
        </div>
      </div>
    </header>
    
    <!-- Current time and phase section -->
    <section class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div>
          <h2 class="text-xl font-semibold mb-2">Current Time</h2>
          <div class="flex items-center space-x-4">
            <div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Local:</p>
              <p id="local-time" class="text-2xl font-bold">--:-- --</p>
            </div>
            <div>
              <p class="text-sm text-gray-600 dark:text-gray-400">Eastern (ET):</p>
              <p id="eastern-time" class="text-2xl font-bold">--:-- --</p>
            </div>
          </div>
        </div>
        <div class="mt-4 md:mt-0 text-center">
          <div class="bg-gradient-to-r from-primary to-primary-light dark:from-primary-dark dark:to-primary text-white rounded-lg px-6 py-3 shadow-lg">
            <h3 class="text-sm uppercase tracking-wide mb-1">Current Phase</h3>
            <div class="flex items-center justify-center">
              <span id="current-phase-emoji" class="emoji-icon mr-2"></span>
              <p id="current-phase" class="text-2xl font-bold">Loading...</p>
            </div>
            <div class="mt-2 text-sm">
              <span id="phase-time-remaining">--:--</span> remaining
            </div>
          </div>
        </div>
      </div>
      
      <!-- Progress bar -->
      <div class="mt-6">
        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
          <div id="phase-progress" class="h-full bg-primary dark:bg-primary-light progress-bar" style="width: 0%"></div>
        </div>
        <div class="flex justify-between mt-1 text-xs text-gray-500 dark:text-gray-400">
          <span id="phase-start-time">--:--</span>
          <span id="phase-end-time">--:--</span>
        </div>
      </div>

      <!-- Sub-phase indicator -->
      <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
          <div class="text-sm text-gray-600 dark:text-gray-400">
            Current Subphase:
          </div>
          <div class="mt-1 sm:mt-0 px-3 py-1 bg-primary/10 dark:bg-primary-dark/20 rounded-full">
            <span id="current-subphase" class="text-sm font-medium text-primary dark:text-primary-light">Loading...</span>
            <span class="mx-2 text-gray-400">|</span>
            <span id="current-subphase-time" class="text-xs text-gray-600 dark:text-gray-400">--:-- - --:--</span>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Current phase details with tabs -->
    <section class="bg-white dark:bg-gray-800 rounded-lg shadow-md mb-6">
      <div class="border-b border-gray-200 dark:border-gray-700">
        <ul class="flex flex-wrap -mb-px" id="phase-tabs">
          <li class="mr-2">
            <button id="overview-tab" class="tab active inline-block p-4 border-b-2 rounded-t-lg">Overview</button>
          </li>
          <li class="mr-2">
            <button id="schedule-tab" class="tab inline-block p-4 border-b-2 border-transparent rounded-t-lg">Full Schedule</button>
          </li>
          <li class="mr-2">
            <button id="trading-tab" class="tab inline-block p-4 border-b-2 border-transparent rounded-t-lg">Trading Tips</button>
          </li>
          <li class="mr-2">
            <button id="journal-tab" class="tab inline-block p-4 border-b-2 border-transparent rounded-t-lg">
              <i class="fas fa-book mr-1"></i> Journal
            </button>
          </li>
          <li class="mr-2">
            <button id="analytics-tab" class="tab inline-block p-4 border-b-2 border-transparent rounded-t-lg">
              <i class="fas fa-chart-bar mr-1"></i> Analytics
            </button>
          </li>
        </ul>
      </div>
      
      <!-- Tab content -->
      <div id="tab-content" class="p-6">
        <!-- Overview tab -->
        <div id="overview-content" class="tab-pane">
          <h2 class="text-xl font-semibold mb-4">Current Phase Details</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2">
              <div class="space-y-4">
                <div class="phase-card bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                  <h3 class="font-semibold flex items-center text-lg mb-2">
                    <span id="current-phase-icon2" class="emoji-icon"></span>
                    <span id="current-phase-title">Loading...</span>
                    <span id="current-phase-time" class="ml-2 text-sm text-gray-500 dark:text-gray-400">--:-- - --:--</span>
                  </h3>
                  <p id="current-phase-description" class="text-gray-700 dark:text-gray-300 text-sm">Loading...</p>
                </div>

                <div id="subphases-container" class="space-y-3">
                  <!-- Current subphases will be populated here -->
                </div>
              </div>
            </div>

            <div>
              <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                <h3 class="font-semibold mb-2 flex items-center">
                  <i class="fas fa-lightbulb text-yellow-custom mr-2"></i>
                  Trading Tips for This Phase
                </h3>
                <div id="current-phase-tips" class="text-sm text-gray-700 dark:text-gray-300 space-y-2">
                  <p>Loading tips...</p>
                </div>
              </div>

              <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <h3 class="font-semibold mb-2 flex items-center">
                  <i class="fas fa-clock text-blue-custom mr-2"></i>
                  Coming Up Next
                </h3>
                <div class="text-sm">
                  <div class="flex items-center mb-1">
                    <span id="next-phase-emoji" class="emoji-icon"></span>
                    <span id="next-phase-name" class="font-medium text-primary dark:text-primary-light">Loading...</span>
                  </div>
                  <p id="next-phase-time" class="text-gray-600 dark:text-gray-400 mb-2">--:-- - --:--</p>
                  <div class="bg-yellow-custom/20 text-yellow-custom px-2 py-1 rounded-full text-xs font-medium inline-flex items-center">
                    <i class="fas fa-hourglass-half mr-1"></i>
                    <span id="time-until-next-phase">-- min</span> until next phase
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Schedule tab -->
        <div id="schedule-content" class="tab-pane hidden">
          <h2 class="text-xl font-semibold mb-4">Complete Market Schedule</h2>
          
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-gray-700">
                <tr>
                  <th scope="col" class="px-4 py-3 w-32">Time (ET)</th>
                  <th scope="col" class="px-4 py-3">Phase</th>
                  <th scope="col" class="px-4 py-3">Market Behavior</th>
                  <th scope="col" class="px-4 py-3">Key Notes</th>
                </tr>
              </thead>
              <tbody id="schedule-table-body">
                <!-- Schedule will be generated here -->
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Trading tips tab -->
        <div id="trading-tab-content" class="tab-pane hidden">
          <h2 class="text-xl font-semibold mb-4">Trading Strategy Guide</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium text-primary dark:text-primary-light mb-3 flex items-center">
                <i class="fas fa-star text-yellow-custom mr-2"></i>
                Best Trading Windows
              </h3>
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="text-xs uppercase bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300">
                    <tr>
                      <th class="px-3 py-2 text-left">Time</th>
                      <th class="px-3 py-2 text-left">Best Strategy</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="border-b border-gray-200 dark:border-gray-600">
                      <td class="px-3 py-2">9:30 AM - 10:30 AM</td>
                      <td class="px-3 py-2">Opening range breakouts or reversals</td>
                    </tr>
                    <tr class="border-b border-gray-200 dark:border-gray-600">
                      <td class="px-3 py-2">10:30 AM - 11:30 AM</td>
                      <td class="px-3 py-2">Trend-following trades</td>
                    </tr>
                    <tr class="border-b border-gray-200 dark:border-gray-600">
                      <td class="px-3 py-2">1:30 PM - 3:00 PM</td>
                      <td class="px-3 py-2">Trend continuation or reversal setups</td>
                    </tr>
                    <tr>
                      <td class="px-3 py-2">3:00 PM - 4:00 PM</td>
                      <td class="px-3 py-2">High volatility, breakout trades</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium text-primary dark:text-primary-light mb-3 flex items-center">
                <i class="fas fa-rocket text-red-custom mr-2"></i>
                Final Thoughts
              </h3>
              <ul class="list-disc pl-5 space-y-2 text-sm text-gray-700 dark:text-gray-300">
                <li>Avoid trading during lunch hours (11:30 AM - 1:30 PM)</li>
                <li>Trade with the trend from 10:00 AM - 11:30 AM & 1:30 PM - 3:00 PM</li>
                <li>Power Hour (3:00 PM - 4:00 PM) is best for momentum trades</li>
                <li>Watch economic releases at 8:30 AM & 10:00 AM--they set the day's tone</li>
              </ul>
            </div>
          </div>
          
          <div class="space-y-4">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium text-primary dark:text-primary-light mb-3">Pre-Market Session (4:00 AM - 9:30 AM) 🌅</h3>
              <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700 dark:text-gray-300">
                <li>Best trades occur before 8:30 AM if there's a clear trend</li>
                <li>High-risk volatility at 8:30 AM (CPI, NFP data)</li>
                <li>Trend setups become clearer by 9:00 AM</li>
              </ul>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium text-primary dark:text-primary-light mb-3">Market Open & Initial Volatility (9:30 AM - 10:00 AM) 🚀</h3>
              <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700 dark:text-gray-300">
                <li>Fake moves are common in the first 5-10 minutes</li>
                <li>Reversals often happen around 9:45-9:50 AM</li>
              </ul>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium text-primary dark:text-primary-light mb-3">Morning Trend Establishment (10:00 AM - 11:30 AM) 📈</h3>
              <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700 dark:text-gray-300">
                <li>Pullbacks between 10:15 - 10:30 AM offer good entries</li>
                <li>Avoid counter-trend trades after 10:15 AM unless a reversal pattern forms</li>
              </ul>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium text-primary dark:text-primary-light mb-3">Midday Consolidation (11:30 AM - 1:30 PM) 😴</h3>
              <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700 dark:text-gray-300">
                <li>Best to avoid trading unless there's a clear range breakout</li>
                <li>Liquidity is low, and price action is often manipulated</li>
              </ul>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium text-primary dark:text-primary-light mb-3">Afternoon Trend Resumption (1:30 PM - 3:00 PM) 🔥</h3>
              <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700 dark:text-gray-300">
                <li>If morning trend continues, trend-following trades work well</li>
                <li>If morning trend was weak, expect a reversal around 1:30 - 2:00 PM</li>
              </ul>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium text-primary dark:text-primary-light mb-3">Power Hour & Closing Volatility (3:00 PM - 4:00 PM) ⚡</h3>
              <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700 dark:text-gray-300">
                <li>Breakouts after 3:00 PM tend to continue into the close</li>
                <li>MOC orders after 3:50 PM can cause fake moves</li>
              </ul>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium text-primary dark:text-primary-light mb-3">After-Hours (4:00 PM - 8:00 PM) 🌙</h3>
              <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700 dark:text-gray-300">
                <li>Avoid trading after 6:30 PM unless an earnings catalyst is in play</li>
              </ul>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium text-primary dark:text-primary-light mb-3">Overnight & Futures Trading (8:00 PM - 4:00 AM) 🌍</h3>
              <ul class="list-disc pl-5 space-y-1 text-sm text-gray-700 dark:text-gray-300">
                <li>European session moves (2:00 - 4:00 AM) can predict the U.S. open</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Journal tab -->
        <div id="journal-tab-content" class="tab-pane hidden">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 space-y-3 md:space-y-0">
            <h2 class="text-xl font-semibold">Trading Journal</h2>
            
            <div class="flex flex-wrap gap-2 items-center">
              <!-- Search box -->
              <div class="relative">
                <input type="text" id="journal-search" placeholder="Search journal entries..." class="w-full px-3 py-1.5 pr-10 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary dark:focus:ring-primary-light">
                <button id="search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              
              <button id="prev-day-btn" class="text-sm px-2 py-1 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light">
                <i class="fas fa-chevron-left"></i> Previous
              </button>
              <button id="today-btn" class="text-sm px-3 py-1 bg-primary/10 text-primary dark:bg-primary-dark/20 dark:text-primary-light rounded-md">
                Today
              </button>
              <button id="next-day-btn" class="text-sm px-2 py-1 text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light">
                Next <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
          
          <!-- Calendar view -->
          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-medium">
                <span id="journal-month-year">Month Year</span>
              </h3>
              <div class="flex gap-2">
                <button id="prev-month-btn" class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <button id="next-month-btn" class="text-gray-600 dark:text-gray-300 hover:text-primary dark:hover:text-primary-light">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
            
            <div class="grid grid-cols-7 gap-1 text-center text-sm">
              <div class="p-1 text-gray-600 dark:text-gray-400">Su</div>
              <div class="p-1 text-gray-600 dark:text-gray-400">Mo</div>
              <div class="p-1 text-gray-600 dark:text-gray-400">Tu</div>
              <div class="p-1 text-gray-600 dark:text-gray-400">We</div>
              <div class="p-1 text-gray-600 dark:text-gray-400">Th</div>
              <div class="p-1 text-gray-600 dark:text-gray-400">Fr</div>
              <div class="p-1 text-gray-600 dark:text-gray-400">Sa</div>
            </div>
            
            <div id="calendar-days" class="grid grid-cols-7 gap-1 text-center mt-1">
              <!-- Calendar days will be generated here -->
            </div>
          </div>
          
          <!-- Selected day and journal entries -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- New entry form -->
            <div class="lg:col-span-1">
              <div id="journal-form-container" class="journal-form-container bg-gray-50 dark:bg-gray-700 rounded-lg p-4 sticky top-4">
                <div class="edit-mode-indicator">
                  <div class="flex items-center text-primary dark:text-primary-light">
                    <i class="fas fa-pencil-alt mr-2"></i>
                    <span class="font-medium">Edit Mode</span>
                  </div>
                  <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">You are currently editing an existing entry.</p>
                </div>

                <h3 class="font-medium mb-3 text-primary dark:text-primary-light flex items-center">
                  <i class="fas fa-plus-circle mr-2 new-entry-icon"></i>
                  <i class="fas fa-edit mr-2 edit-entry-icon hidden"></i>
                  <span id="form-title">New Journal Entry</span>
                </h3>
                
                <div class="space-y-3">
                  <div>
                    <div class="flex justify-between mb-1">
                      <label class="text-sm text-gray-600 dark:text-gray-400">Selected Date</label>
                      <span id="current-journal-date" class="text-sm font-medium">--/--/----</span>
                    </div>
                    <input type="date" id="journal-date" class="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md text-base">
                  </div>
                  
                  <div>
                    <div class="flex justify-between mb-1">
                      <label class="text-sm text-gray-600 dark:text-gray-400">Current Time</label>
                      <span id="journal-time" class="text-sm font-medium">--:-- --</span>
                    </div>
                    <div class="text-sm bg-primary/10 dark:bg-primary-dark/20 text-primary dark:text-primary-light rounded px-3 py-2">
                      <span id="journal-phase">Loading phase...</span>
                    </div>
                  </div>
                  
                  <div>
                    <label class="text-sm text-gray-600 dark:text-gray-400 block mb-1">Your Note</label>
                    <div class="flex items-center mb-1">
                      <button id="add-timestamp-btn" class="text-xs px-2 py-1 bg-primary/10 text-primary dark:bg-primary-dark/20 dark:text-primary-light rounded mr-2">
                        <i class="fas fa-clock mr-1"></i> Insert Time
                      </button>
                      <span class="text-xs text-gray-500 dark:text-gray-400">System time: <span id="journal-system-time">--:--:--</span></span>
                    </div>
                    <textarea id="journal-note" rows="5" placeholder="Enter your trade details, observations, or notes..." class="w-full px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md text-base"></textarea>
                  </div>
                  
                  <div class="mb-3">
                    <label class="text-sm text-gray-600 dark:text-gray-400 block mb-1">
                      <i class="fas fa-image mr-1"></i> Add Images (optional)
                    </label>
                    <div class="flex flex-col space-y-2">
                      <div class="flex items-center">
                        <label for="journal-image-upload" class="cursor-pointer px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-md transition-colors text-sm">
                          <i class="fas fa-upload mr-1"></i> Choose Images
                        </label>
                        <input type="file" id="journal-image-upload" accept="image/*" multiple class="hidden">
                        <span id="image-file-name" class="ml-2 text-sm text-gray-600 dark:text-gray-400">No files chosen</span>
                      </div>
                      <div id="image-previews-container" class="image-previews-container hidden">
                        <!-- Image previews will be added here -->
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <label class="text-sm text-gray-600 dark:text-gray-400 block mb-1">Tags (optional)</label>
                    <div class="flex items-center">
                      <input type="text" id="journal-tag-input" placeholder="Add tag and press Enter" class="flex-1 px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                      <button id="add-tag-btn" class="ml-2 px-3 py-2 bg-primary text-white rounded-md">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                    <div id="journal-tags-container" class="flex flex-wrap gap-2 mt-2"></div>
                  </div>
                  
                  <div>
                    <label class="text-sm text-gray-600 dark:text-gray-400 block mb-1">Entry Type</label>
                    <div class="flex flex-wrap gap-2">
                      <button data-type="observation" class="entry-type-btn px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-primary hover:text-white hover:border-primary dark:hover:bg-primary-dark dark:hover:border-primary-dark">
                        Observation
                      </button>
                      <button data-type="trade" class="entry-type-btn px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-primary hover:text-white hover:border-primary dark:hover:bg-primary-dark dark:hover:border-primary-dark">
                        Trade
                      </button>
                      <button data-type="strategy" class="entry-type-btn px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-primary hover:text-white hover:border-primary dark:hover:bg-primary-dark dark:hover:border-primary-dark">
                        Strategy
                      </button>
                      <button data-type="note" class="entry-type-btn px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-600 hover:bg-primary hover:text-white hover:border-primary dark:hover:bg-primary-dark dark:hover:border-primary-dark">
                        Note
                      </button>
                    </div>
                    <input type="hidden" id="journal-entry-type" value="observation">
                    <input type="hidden" id="journal-entry-id" value="">
                  </div>
                  
                  <div id="journal-form-buttons" class="flex space-x-2">
                    <button id="save-journal-entry" class="flex-1 bg-primary hover:bg-primary-dark text-white py-2 px-4 rounded transition-colors">
                      <i class="fas fa-save mr-1"></i> <span id="save-button-text">Save Entry</span>
                    </button>
                    <button id="cancel-edit" class="hidden bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white py-2 px-4 rounded transition-colors">
                      <i class="fas fa-times mr-1"></i> Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Journal entries for selected day -->
            <div class="lg:col-span-2">
              <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <h3 class="font-medium mb-3 flex items-center justify-between">
                  <div>
                    Entries for <span id="entries-date">Today</span>
                    <span id="entries-count" class="ml-2 text-sm bg-primary/20 text-primary dark:bg-primary-dark/30 dark:text-primary-light px-2 py-0.5 rounded-full">0</span>
                  </div>
                  
                  <div class="flex gap-2">
                    <div class="relative daterange-picker">
                      <button id="filter-btn" class="text-xs px-3 py-1.5 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded flex items-center">
                        <i class="fas fa-filter mr-1"></i> Filter
                        <i class="fas fa-chevron-down ml-1 text-gray-500"></i>
                      </button>
                      <div id="filter-menu" class="daterange-menu bg-white dark:bg-gray-800 p-3 hidden">
                        <div class="mb-3">
                          <h4 class="text-sm font-medium mb-2">Filter by Type</h4>
                          <div class="flex flex-wrap gap-2">
                            <button data-filter="all" class="filter-type-btn px-2 py-1 text-xs rounded bg-primary text-white">All</button>
                            <button data-filter="observation" class="filter-type-btn px-2 py-1 text-xs rounded bg-gray-200 dark:bg-gray-700 text-blue-custom">Observations</button>
                            <button data-filter="trade" class="filter-type-btn px-2 py-1 text-xs rounded bg-gray-200 dark:bg-gray-700 text-green-custom">Trades</button>
                            <button data-filter="strategy" class="filter-type-btn px-2 py-1 text-xs rounded bg-gray-200 dark:bg-gray-700 text-purple-custom">Strategies</button>
                            <button data-filter="note" class="filter-type-btn px-2 py-1 text-xs rounded bg-gray-200 dark:bg-gray-700 text-yellow-custom">Notes</button>
                          </div>
                        </div>
                        <div class="mb-3">
                          <h4 class="text-sm font-medium mb-2">Filter by Phase</h4>
                          <select id="phase-filter" class="w-full px-2 py-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded text-sm">
                            <option value="all">All Phases</option>
                            <option value="pre-market">Pre-Market</option>
                            <option value="market-open">Market Open</option>
                            <option value="morning-trend">Morning Trend</option>
                            <option value="midday">Midday</option>
                            <option value="afternoon-trend">Afternoon Trend</option>
                            <option value="power-hour">Power Hour</option>
                            <option value="after-hours">After-Hours</option>
                            <option value="overnight">Overnight</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <h4 class="text-sm font-medium mb-2">Filter by Tag</h4>
                          <div id="tag-filter-container" class="flex flex-wrap gap-1 mb-2">
                            <!-- Tag filters will be added here -->
                          </div>
                          <input type="text" id="tag-filter-input" placeholder="Enter tag name" class="w-full px-2 py-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded text-sm">
                        </div>
                        <div>
                          <button id="apply-filters" class="w-full px-3 py-1 bg-primary text-white rounded">Apply Filters</button>
                        </div>
                      </div>
                    </div>
                    
                    <button id="clear-filters" class="text-xs px-3 py-1.5 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary-light hidden">
                      <i class="fas fa-times mr-1"></i> Clear Filters
                    </button>
                  </div>
                </h3>
                
                <div id="no-entries-message" class="text-center py-8 text-gray-500 dark:text-gray-400">
                  <i class="fas fa-book-open text-3xl mb-2"></i>
                  <p>No entries for this day yet. Add your first note!</p>
                </div>
                
                <div id="filtered-message" class="bg-yellow-custom/10 text-yellow-custom px-3 py-2 rounded mb-3 text-sm hidden">
                  Showing filtered results: <span id="filter-description"></span>
                </div>
                
                <div id="journal-entries-container" class="space-y-4 mt-4">
                  <!-- Journal entries will be generated here -->
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Analytics tab -->
        <div id="analytics-tab-content" class="tab-pane hidden">
          <h2 class="text-xl font-semibold mb-4">Journal Analytics</h2>
          
          <!-- Date range selector -->
          <div class="mb-6 bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <h3 class="font-medium mb-3 flex items-center">
              <i class="fas fa-calendar-alt text-primary dark:text-primary-light mr-2"></i>
              Date Range
            </h3>
            <div class="flex flex-wrap gap-2 mb-3">
              <button class="preset-btn active text-xs px-3 py-1.5 bg-gray-200 dark:bg-gray-600 rounded" data-range="all">All Time</button>
              <button class="preset-btn text-xs px-3 py-1.5 bg-gray-200 dark:bg-gray-600 rounded" data-range="week">This Week</button>
              <button class="preset-btn text-xs px-3 py-1.5 bg-gray-200 dark:bg-gray-600 rounded" data-range="month">This Month</button>
              <button class="preset-btn text-xs px-3 py-1.5 bg-gray-200 dark:bg-gray-600 rounded" data-range="quarter">Last 3 Months</button>
            </div>
            <div class="flex flex-col sm:flex-row gap-2">
              <div class="flex-1">
                <label class="text-xs text-gray-600 dark:text-gray-400 block mb-1">Start Date</label>
                <input type="date" id="analytics-start-date" class="w-full px-3 py-1.5 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
              </div>
              <div class="flex-1">
                <label class="text-xs text-gray-600 dark:text-gray-400 block mb-1">End Date</label>
                <input type="date" id="analytics-end-date" class="w-full px-3 py-1.5 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
              </div>
              <div class="self-end">
                <button id="update-analytics" class="h-full px-4 py-1.5 bg-primary text-white rounded-md">
                  <i class="fas fa-sync-alt mr-1"></i> Update
                </button>
              </div>
            </div>
          </div>
          
          <!-- Summary cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="analytics-card bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="text-sm text-gray-600 dark:text-gray-400 mb-1">Total Entries</h3>
              <div class="flex items-center justify-between">
                <p id="total-entries" class="text-3xl font-bold">0</p>
                <div class="text-primary dark:text-primary-light bg-primary/10 dark:bg-primary-dark/20 p-3 rounded-lg">
                  <i class="fas fa-book"></i>
                </div>
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                <span id="entries-trend">0% </span> from previous period
              </div>
            </div>
            
            <div class="analytics-card bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="text-sm text-gray-600 dark:text-gray-400 mb-1">Most Active Phase</h3>
              <div class="flex items-center justify-between">
                <div>
                  <p id="most-active-phase" class="text-xl font-bold">-</p>
                  <p id="most-active-phase-count" class="text-sm text-gray-600 dark:text-gray-400">0 entries</p>
                </div>
                <div id="most-active-phase-icon" class="text-yellow-custom bg-yellow-custom/10 p-3 rounded-lg text-xl">
                  🚀
                </div>
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                <span id="active-phase-percentage">0%</span> of all entries
              </div>
            </div>
            
            <div class="analytics-card bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="text-sm text-gray-600 dark:text-gray-400 mb-1">Entry Type Distribution</h3>
              <div class="flex items-center justify-between">
                <div>
                  <p id="top-entry-type" class="text-xl font-bold">-</p>
                  <p id="top-entry-type-count" class="text-sm text-gray-600 dark:text-gray-400">0 entries</p>
                </div>
                <div id="top-entry-type-icon" class="text-blue-custom bg-blue-custom/10 p-3 rounded-lg">
                  <i class="fas fa-eye"></i>
                </div>
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                <span id="entry-type-percentage">0%</span> of all entries
              </div>
            </div>
            
            <div class="analytics-card bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="text-sm text-gray-600 dark:text-gray-400 mb-1">Most Used Tags</h3>
              <div class="flex items-center justify-between">
                <div>
                  <p id="top-tag" class="text-xl font-bold">-</p>
                  <p id="top-tag-count" class="text-sm text-gray-600 dark:text-gray-400">0 occurrences</p>
                </div>
                <div class="text-purple-custom bg-purple-custom/10 p-3 rounded-lg">
                  <i class="fas fa-tags"></i>
                </div>
              </div>
              <div class="mt-2 flex flex-wrap gap-1">
                <span id="popular-tags" class="text-xs">No tags yet</span>
              </div>
            </div>
          </div>
          
          <!-- Charts -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium mb-4">Entry Distribution by Market Phase</h3>
              <div class="h-64">
                <canvas id="phase-distribution-chart"></canvas>
              </div>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium mb-4">Daily Journal Activity</h3>
              <div class="h-64">
                <canvas id="activity-chart"></canvas>
              </div>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium mb-4">Entry Types Over Time</h3>
              <div class="h-64">
                <canvas id="entry-types-chart"></canvas>
              </div>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h3 class="font-medium mb-4">Tag Cloud</h3>
              <div id="tag-cloud" class="h-64 flex flex-wrap items-center justify-center gap-2">
                <!-- Tag cloud items will be added here -->
              </div>
            </div>
          </div>
          
          <!-- Recent entries -->
          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-6">
            <h3 class="font-medium mb-4">Recent Entries</h3>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-xs uppercase bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300">
                  <tr>
                    <th class="px-3 py-2 text-left">Date</th>
                    <th class="px-3 py-2 text-left">Time</th>
                    <th class="px-3 py-2 text-left">Phase</th>
                    <th class="px-3 py-2 text-left">Type</th>
                    <th class="px-3 py-2 text-left">Note Preview</th>
                    <th class="px-3 py-2 text-left">Action</th>
                  </tr>
                </thead>
                <tbody id="recent-entries-table">
                  <!-- Recent entries will be added here -->
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Export options -->
          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <h3 class="font-medium mb-3">Export Data</h3>
            <div class="flex flex-wrap gap-3">
              <button id="export-json-btn" class="px-4 py-2 bg-primary text-white rounded-md">
                <i class="fas fa-download mr-1"></i> Export as JSON
              </button>
              <button id="export-csv-btn" class="px-4 py-2 bg-green-custom text-white rounded-md">
                <i class="fas fa-file-csv mr-1"></i> Export as CSV
              </button>
              <button id="print-report-btn" class="px-4 py-2 bg-blue-custom text-white rounded-md">
                <i class="fas fa-print mr-1"></i> Print Report
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Timeline section -->
    <section class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold mb-6">Daily Market Timeline</h2>
      <div class="overflow-x-auto">
        <div class="min-w-[768px]">
          <div class="relative">
            <!-- Timeline line -->
            <div class="absolute h-1 bg-gray-200 dark:bg-gray-700 top-5 left-0 right-0"></div>
            
            <!-- Timeline indicators -->
            <div id="timeline-indicators" class="flex justify-between relative">
              <!-- Timeline dots will be generated here -->
            </div>
          </div>
          
          <!-- Timeline phases details -->
          <div id="timeline-details" class="mt-8 grid grid-cols-8 gap-2">
            <!-- Timeline details will be generated here -->
          </div>
        </div>
      </div>
    </section>
    
    <!-- Best trading windows section -->
    <section class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">Best Trading Windows</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="phase-card bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
          <div class="text-center">
            <span class="text-xs bg-green-custom/20 text-green-custom px-2 py-1 rounded">9:30 AM - 10:30 AM</span>
            <h3 class="font-medium mt-2">Opening Range</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Breakouts or reversals</p>
          </div>
        </div>
        
        <div class="phase-card bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
          <div class="text-center">
            <span class="text-xs bg-green-custom/20 text-green-custom px-2 py-1 rounded">10:30 AM - 11:30 AM</span>
            <h3 class="font-medium mt-2">Morning Trend</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Trend-following trades</p>
          </div>
        </div>
        
        <div class="phase-card bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
          <div class="text-center">
            <span class="text-xs bg-green-custom/20 text-green-custom px-2 py-1 rounded">1:30 PM - 3:00 PM</span>
            <h3 class="font-medium mt-2">Afternoon Trend</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Continuation or reversal</p>
          </div>
        </div>
        
        <div class="phase-card bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
          <div class="text-center">
            <span class="text-xs bg-green-custom/20 text-green-custom px-2 py-1 rounded">3:00 PM - 4:00 PM</span>
            <h3 class="font-medium mt-2">Power Hour</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Momentum trades</p>
          </div>
        </div>
      </div>
      
      <!-- Final thoughts -->
      <div class="mt-6 p-4 bg-primary/10 dark:bg-primary-dark/20 rounded-lg">
        <h3 class="font-semibold mb-2 text-primary dark:text-primary-light flex items-center">
          <span class="emoji-icon">🚀</span> Final Thoughts
        </h3>
        <ul class="list-disc pl-5 space-y-1 text-sm">
          <li>Avoid trading during lunch hours (11:30 AM - 1:30 PM)</li>
          <li>Trade with the trend from 10:00 AM - 11:30 AM & 1:30 PM - 3:00 PM</li>
          <li>Power Hour (3:00 PM - 4:00 PM) is best for momentum trades</li>
          <li>Watch economic releases at 8:30 AM & 10:00 AM--they set the day's tone</li>
        </ul>
      </div>
    </section>
    
    <!-- Delete confirmation modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-md mx-4 shadow-xl">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Confirm Delete</h3>
            <button id="close-delete-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <p class="mb-6">Are you sure you want to delete this journal entry? This action cannot be undone.</p>
          
          <div class="flex justify-end gap-3">
            <button id="cancel-delete" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded">
              Cancel
            </button>
            <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Settings modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-md mx-4 shadow-xl">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Settings</h3>
            <button id="close-settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="space-y-6">
            <div>
              <h4 class="font-medium mb-2">Notifications</h4>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <span>Enable notifications</span>
                  </label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input id="enable-notifications" type="checkbox" name="enable-notifications" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="enable-notifications" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                  </div>
                </div>
                
                <div class="flex items-center justify-between">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <span>Phase change alert</span>
                  </label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input id="phase-change-alert" type="checkbox" name="phase-change-alert" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="phase-change-alert" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                  </div>
                </div>
                
                <div class="flex items-center justify-between">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <span>Subphase change alert</span>
                  </label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input id="subphase-change-alert" type="checkbox" name="subphase-change-alert" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="subphase-change-alert" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                  </div>
                </div>
                
                <div class="flex items-center justify-between">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <span>Sound alerts</span>
                  </label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input id="sound-alerts" type="checkbox" name="sound-alerts" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="sound-alerts" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                  </div>
                </div>
                
                <div class="flex items-center justify-between">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <span>Advanced warning (5 min before phase change)</span>
                  </label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input id="advanced-warning" type="checkbox" name="advanced-warning" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="advanced-warning" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                  </div>
                </div>
              </div>
            </div>
            
            <div>
              <h4 class="font-medium mb-2">Display</h4>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <span>Show timeline</span>
                  </label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input id="show-timeline" type="checkbox" name="show-timeline" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="show-timeline" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                  </div>
                </div>
                
                <div class="flex items-center justify-between">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <span>Show best trading windows</span>
                  </label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input id="show-best-windows" type="checkbox" name="show-best-windows" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="show-best-windows" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                  </div>
                </div>
                
                <div class="flex items-center justify-between">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <span>Show analytics tab</span>
                  </label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input id="show-analytics" type="checkbox" name="show-analytics" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="show-analytics" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                  </div>
                </div>
              </div>
            </div>
            
            <div>
              <h4 class="font-medium mb-2">Journal</h4>
              <div class="space-y-3">
                <div class="flex items-center justify-between">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <span>Daily journal reminders</span>
                  </label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input id="journal-reminders" type="checkbox" name="journal-reminders" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="journal-reminders" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                  </div>
                </div>
                
                <div class="flex items-center justify-between">
                  <label class="flex items-center space-x-2 cursor-pointer">
                    <span>Auto-tag entries</span>
                  </label>
                  <div class="relative inline-block w-10 mr-2 align-middle select-none">
                    <input id="auto-tag" type="checkbox" name="auto-tag" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="auto-tag" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                  </div>
                </div>
                
                <div>
                  <label class="block mb-1 text-sm">Data Management</label>
                  <div class="flex space-x-2">
                    <button id="export-journal" class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded">
                      Export Journal
                    </button>
                    <button id="import-journal" class="text-xs px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded">
                      Import Journal
                    </button>
                    <button id="clear-journal" class="text-xs px-2 py-1 bg-red-500/10 text-red-500 dark:bg-red-500/20 dark:text-red-400 rounded">
                      Clear All Entries
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
            <button id="save-settings" class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-2 px-4 rounded transition-colors">
              Save Settings
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Export data modal -->
    <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-2xl mx-4 shadow-xl">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Export Journal Data</h3>
            <button id="close-export-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="mb-4">
            <p class="mb-2">Copy the text below to back up your journal data:</p>
            <textarea id="export-data" rows="10" class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-mono" readonly></textarea>
          </div>
          
          <div class="flex justify-between">
            <button id="copy-export-data" class="px-4 py-2 bg-primary text-white rounded">
              <i class="fas fa-copy mr-1"></i> Copy to Clipboard
            </button>
            <button id="download-export-data" class="px-4 py-2 bg-green-custom text-white rounded">
              <i class="fas fa-download mr-1"></i> Download as File
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Import data modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-2xl mx-4 shadow-xl">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Import Journal Data</h3>
            <button id="close-import-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="mb-4">
            <p class="mb-2">Paste your journal data below or upload a file:</p>
            <textarea id="import-data" rows="10" class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-mono" placeholder="Paste JSON data here..."></textarea>
          </div>
          
          <div class="mb-4">
            <div class="flex items-center space-x-2">
              <label for="import-file" class="flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded cursor-pointer">
                <i class="fas fa-upload mr-1"></i> Upload File
              </label>
              <input type="file" id="import-file" accept=".json" class="hidden">
              <span id="import-file-name" class="text-sm text-gray-600 dark:text-gray-400">No file selected</span>
            </div>
          </div>
          
          <div class="flex justify-between items-center">
            <div class="space-x-1">
              <input type="radio" id="import-merge" name="import-mode" value="merge" checked>
              <label for="import-merge" class="text-sm">Merge with current data</label>
              
              <input type="radio" id="import-replace" name="import-mode" value="replace" class="ml-4">
              <label for="import-replace" class="text-sm">Replace all data</label>
            </div>
            
            <button id="confirm-import" class="px-4 py-2 bg-primary text-white rounded">
              <i class="fas fa-file-import mr-1"></i> Import Data
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Clear journal confirmation modal -->
    <div id="clear-journal-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-md mx-4 shadow-xl">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-red-500">Clear All Journal Entries</h3>
            <button id="close-clear-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="mb-6">
            <p class="mb-2 font-medium">Warning: This action cannot be undone!</p>
            <p class="text-gray-600 dark:text-gray-400">All your journal entries will be permanently deleted. Consider exporting your data before clearing.</p>
          </div>
          
          <div class="flex justify-end gap-3">
            <button id="cancel-clear" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded">
              Cancel
            </button>
            <button id="confirm-clear" class="px-4 py-2 bg-red-500 text-white rounded">
              Clear All Data
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Image fullscreen view modal -->
    <div id="image-fullscreen-modal" class="image-fullscreen-container hidden">
      <img id="fullscreen-image" class="image-fullscreen" src="" alt="Journal image">
      <button id="close-fullscreen-image" class="image-fullscreen-close">
        <i class="fas fa-times"></i>
      </button>
      <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-2">
        <div id="fullscreen-thumbnails" class="flex gap-2"></div>
      </div>
    </div>
    
    <!-- Notification toast -->
    <div id="notification-toast" class="fixed bottom-4 right-4 bg-primary dark:bg-primary-dark text-white p-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 max-w-xs z-40">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          <i class="fas fa-bell"></i>
        </div>
        <div class="ml-3 flex-1">
          <p id="notification-toast-text" class="text-sm font-medium">New phase: Pre-Market Session</p>
          <div id="notification-sound-indicator" class="hidden mt-1 text-xs flex items-center">
            <div class="sound-wave text-white">
              <span></span>
              <span></span>
              <span></span>
              <span></span>
            </div>
            <span class="ml-1">Sound played</span>
          </div>
        </div>
        <button id="close-notification" class="ml-4 flex-shrink-0 text-white text-sm">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Set dark mode based on user preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });

    // Market phase data with every detail from the provided information
    const marketPhases = [
      {
        id: "pre-market",
        name: "Pre-Market Session",
        shortName: "Pre-Market",
        emoji: "🌅",
        timeRange: "4:00 AM - 9:30 AM",
        timeStart: { hours: 4, minutes: 0 },
        timeEnd: { hours: 9, minutes: 30 },
        description: "Pre-market trading session before regular market hours.",
        tradingTips: [
          "Best trades occur before 8:30 AM if there's a clear trend.",
          "High-risk volatility at 8:30 AM (CPI, NFP data).",
          "Trend setups become clearer by 9:00 AM."
        ],
        subphases: [
          {
            id: "pre-market-early",
            name: "Early Pre-Market",
            timeRange: "4:00 AM - 6:30 AM",
            behavior: "Low liquidity, slow movements",
            keyNotes: "Mostly algo & institutional positioning"
          },
          {
            id: "pre-market-eu",
            name: "European Influence",
            timeRange: "6:30 AM - 8:00 AM",
            behavior: "More volatility, futures react to EU markets",
            keyNotes: "European session influences"
          },
          {
            id: "pre-market-pre-report",
            name: "Pre-Reports",
            timeRange: "8:00 AM - 8:30 AM",
            behavior: "Positioning before economic reports",
            keyNotes: "Traders prepare for CPI, NFP releases"
          },
          {
            id: "pre-market-reports",
            name: "Economic Reports",
            timeRange: "8:30 AM - 9:00 AM",
            behavior: "High volatility if major reports drop",
            keyNotes: "Big moves on macroeconomic news"
          },
          {
            id: "pre-market-prep",
            name: "Pre-Open Preparation",
            timeRange: "9:00 AM - 9:30 AM",
            behavior: "Pre-market trend confirmation",
            keyNotes: "Market makers adjust for open"
          }
        ]
      },
      {
        id: "market-open",
        name: "Market Open & Initial Volatility",
        shortName: "Opening",
        emoji: "🚀",
        timeRange: "9:30 AM - 10:00 AM",
        timeStart: { hours: 9, minutes: 30 },
        timeEnd: { hours: 10, minutes: 0 },
        description: "First 30 minutes of regular market trading with high volatility and initial price discovery.",
        tradingTips: [
          "Fake moves are common in the first 5-10 minutes.",
          "Reversals often happen around 9:45-9:50 AM."
        ],
        subphases: [
          {
            id: "market-open-initial",
            name: "Initial Open",
            timeRange: "9:30 AM - 9:45 AM",
            behavior: "High volatility, spreads widen",
            keyNotes: "Stop hunts, liquidity grabs, fake breakouts"
          },
          {
            id: "market-open-trend",
            name: "Trend Formation",
            timeRange: "9:45 AM - 10:00 AM",
            behavior: "Trend begins forming",
            keyNotes: "Volume stabilizes, clearer market bias"
          }
        ]
      },
      {
        id: "morning-trend",
        name: "Morning Trend Establishment",
        shortName: "Morning Trend",
        emoji: "📈",
        timeRange: "10:00 AM - 11:30 AM",
        timeStart: { hours: 10, minutes: 0 },
        timeEnd: { hours: 11, minutes: 30 },
        description: "Period where the morning trend is established with strong directional moves.",
        tradingTips: [
          "Pullbacks between 10:15 - 10:30 AM offer good entries.",
          "Avoid counter-trend trades after 10:15 AM unless a reversal pattern forms."
        ],
        subphases: [
          {
            id: "morning-trend-institutional",
            name: "Institutional Moves",
            timeRange: "10:00 AM - 10:15 AM",
            behavior: "Institutional moves begin",
            keyNotes: "Real market direction emerges"
          },
          {
            id: "morning-trend-strong",
            name: "Strong Trend",
            timeRange: "10:15 AM - 11:00 AM",
            behavior: "Strong trends emerge",
            keyNotes: "Best time for trend-following strategies"
          },
          {
            id: "morning-trend-slow",
            name: "Momentum Slowing",
            timeRange: "11:00 AM - 11:30 AM",
            behavior: "Momentum slows",
            keyNotes: "Some profit-taking occurs"
          }
        ]
      },
      {
        id: "midday",
        name: "Midday Consolidation",
        shortName: "Midday",
        emoji: "😴",
        timeRange: "11:30 AM - 1:30 PM",
        timeStart: { hours: 11, minutes: 30 },
        timeEnd: { hours: 13, minutes: 30 },
        description: "Midday consolidation and lunch hour with decreased volume and choppy price action.",
        tradingTips: [
          "Best to avoid trading unless there's a clear range breakout.",
          "Liquidity is low, and price action is often manipulated."
        ],
        subphases: [
          {
            id: "midday-early",
            name: "Early Lunch Hour",
            timeRange: "11:30 AM - 12:30 PM",
            behavior: "Choppy price action, algo-driven",
            keyNotes: "Avoid trading, low volume"
          },
          {
            id: "midday-late",
            name: "Late Lunch Hour",
            timeRange: "12:30 PM - 1:30 PM",
            behavior: "Fake breakouts possible",
            keyNotes: "Market makers hunt liquidity"
          }
        ]
      },
      {
        id: "afternoon-trend",
        name: "Afternoon Trend Resumption",
        shortName: "Afternoon Trend",
        emoji: "🔥",
        timeRange: "1:30 PM - 3:00 PM",
        timeStart: { hours: 13, minutes: 30 },
        timeEnd: { hours: 15, minutes: 0 },
        description: "Afternoon trend direction becomes clear with institutional positioning for the close.",
        tradingTips: [
          "If morning trend continues, trend-following trades work well.",
          "If morning trend was weak, expect a reversal around 1:30 - 2:00 PM."
        ],
        subphases: [
          {
            id: "afternoon-trend-direction",
            name: "Direction Setting",
            timeRange: "1:30 PM - 2:00 PM",
            behavior: "Market picks direction",
            keyNotes: "Trend resumption or reversal begins"
          },
          {
            id: "afternoon-trend-positioning",
            name: "Institutional Positioning",
            timeRange: "2:00 PM - 2:30 PM",
            behavior: "Institutional positioning",
            keyNotes: "Larger players enter before power hour"
          },
          {
            id: "afternoon-trend-acceleration",
            name: "Trend Acceleration",
            timeRange: "2:30 PM - 3:00 PM",
            behavior: "Trend acceleration",
            keyNotes: "Big moves possible"
          }
        ]
      },
      {
        id: "power-hour",
        name: "Power Hour & Closing Volatility",
        shortName: "Power Hour",
        emoji: "⚡",
        timeRange: "3:00 PM - 4:00 PM",
        timeStart: { hours: 15, minutes: 0 },
        timeEnd: { hours: 16, minutes: 0 },
        description: "Final hour of regular trading with high volatility and closing positioning.",
        tradingTips: [
          "Breakouts after 3:00 PM tend to continue into the close.",
          "MOC orders after 3:50 PM can cause fake moves."
        ],
        subphases: [
          {
            id: "power-hour-early",
            name: "Early Power Hour",
            timeRange: "3:00 PM - 3:30 PM",
            behavior: "High volatility, breakout moves",
            keyNotes: "Hedge funds rebalance positions"
          },
          {
            id: "power-hour-moc",
            name: "MOC Orders",
            timeRange: "3:30 PM - 3:50 PM",
            behavior: "Sharp price swings",
            keyNotes: "Market-on-close (MOC) orders affect price"
          },
          {
            id: "power-hour-close",
            name: "Closing Minutes",
            timeRange: "3:50 PM - 4:00 PM",
            behavior: "Last-minute liquidity grabs",
            keyNotes: "Often reverses into close"
          }
        ]
      },
      {
        id: "after-hours",
        name: "After-Hours",
        shortName: "After-Hours",
        emoji: "🌙",
        timeRange: "4:00 PM - 8:00 PM",
        timeStart: { hours: 16, minutes: 0 },
        timeEnd: { hours: 20, minutes: 0 },
        description: "After-hours trading session with decreased liquidity and earnings reports impact.",
        tradingTips: [
          "Avoid trading after 6:30 PM unless an earnings catalyst is in play."
        ],
        subphases: [
          {
            id: "after-hours-earnings",
            name: "Earnings Reports",
            timeRange: "4:00 PM - 4:30 PM",
            behavior: "Earnings reports impact price",
            keyNotes: "Tech stocks move significantly"
          },
          {
            id: "after-hours-mid",
            name: "Mid After-Hours",
            timeRange: "4:30 PM - 6:30 PM",
            behavior: "Liquidity drops, wide spreads",
            keyNotes: "Harder to execute large trades"
          },
          {
            id: "after-hours-late",
            name: "Late After-Hours",
            timeRange: "6:30 PM - 8:00 PM",
            behavior: "Minimal movement",
            keyNotes: "Mostly algo-driven"
          }
        ]
      },
      {
        id: "overnight",
        name: "Overnight & Futures Trading",
        shortName: "Overnight",
        emoji: "🌍",
        timeRange: "8:00 PM - 4:00 AM",
        timeStart: { hours: 20, minutes: 0 },
        timeEnd: { hours: 4, minutes: 0 },
        description: "Overnight futures trading session with low liquidity until European markets open.",
        tradingTips: [
          "European session moves (2:00 - 4:00 AM) can predict the U.S. open."
        ],
        subphases: [
          {
            id: "overnight-early",
            name: "Early Overnight",
            timeRange: "8:00 PM - 2:00 AM",
            behavior: "Very low liquidity",
            keyNotes: "Mostly futures traders"
          },
          {
            id: "overnight-eu",
            name: "European Influence",
            timeRange: "2:00 AM - 4:00 AM",
            behavior: "European market influences begin",
            keyNotes: "Can set the tone for the pre-market"
          }
        ]
      }
    ];

    // Best trading windows summary data
    const bestTradingWindows = [
      {
        timeRange: "9:30 AM - 10:30 AM",
        strategy: "Opening range breakouts or reversals"
      },
      {
        timeRange: "10:30 AM - 11:30 AM",
        strategy: "Trend-following trades"
      },
      {
        timeRange: "1:30 PM - 3:00 PM",
        strategy: "Trend continuation or reversal setups"
      },
      {
        timeRange: "3:00 PM - 4:00 PM",
        strategy: "High volatility, breakout trades"
      }
    ];

    // Final thoughts data
    const finalThoughts = [
      "Avoid trading during lunch hours (11:30 AM - 1:30 PM).",
      "Trade with the trend from 10:00 AM - 11:30 AM & 1:30 PM - 3:00 PM.",
      "Power Hour (3:00 PM - 4:00 PM) is best for momentum trades.",
      "Watch economic releases at 8:30 AM & 10:00 AM--they set the day's tone."
    ];

    // Common market terms for auto-tagging
    const marketTerms = [
      { term: "support", tag: "support" },
      { term: "resistance", tag: "resistance" },
      { term: "breakout", tag: "breakout" },
      { term: "reversal", tag: "reversal" },
      { term: "trend", tag: "trend" },
      { term: "volume", tag: "volume" },
      { term: "flag", tag: "pattern" },
      { term: "wedge", tag: "pattern" },
      { term: "triangle", tag: "pattern" },
      { term: "consolidation", tag: "consolidation" },
      { term: "liquidity", tag: "liquidity" },
      { term: "bull", tag: "bullish" },
      { term: "bear", tag: "bearish" },
      { term: "stop loss", tag: "risk-management" },
      { term: "take profit", tag: "risk-management" },
      { term: "divergence", tag: "divergence" },
      { term: "candle", tag: "candlestick" },
      { term: "engulfing", tag: "candlestick" },
      { term: "doji", tag: "candlestick" },
      { term: "hammer", tag: "candlestick" },
      { term: "vwap", tag: "indicator" },
      { term: "macd", tag: "indicator" },
      { term: "rsi", tag: "indicator" },
      { term: "ma", tag: "indicator" },
      { term: "ema", tag: "indicator" },
      { term: "volatility", tag: "volatility" },
      { term: "scalp", tag: "scalping" },
      { term: "momentum", tag: "momentum" },
      { term: "gap", tag: "gap" },
      { term: "squeeze", tag: "volatility" }
    ];

    // Entry types and their colors
    const entryTypes = {
      observation: {
        icon: 'fa-eye',
        color: 'text-blue-custom',
        bgColor: 'bg-blue-custom/10',
        label: 'Observation'
      },
      trade: {
        icon: 'fa-chart-line',
        color: 'text-green-custom',
        bgColor: 'bg-green-custom/10',
        label: 'Trade'
      },
      strategy: {
        icon: 'fa-chess',
        color: 'text-purple-custom',
        bgColor: 'bg-purple-custom/10',
        label: 'Strategy'
      },
      note: {
        icon: 'fa-sticky-note',
        color: 'text-yellow-custom',
        bgColor: 'bg-yellow-custom/10',
        label: 'Note'
      }
    };

    // User settings with default values
    let userSettings = {
      notifications: {
        enabled: true,
        phaseChange: true,
        subphaseChange: true,
        soundAlerts: true,
        advancedWarning: true
      },
      display: {
        showTimeline: true,
        showBestWindows: true,
        showAnalytics: true
      },
      journal: {
        reminders: true,
        autoTag: true
      }
    };

    // Try to load saved settings from localStorage
    try {
      const savedSettings = localStorage.getItem('nasdaq-timing-settings');
      if (savedSettings) {
        userSettings = JSON.parse(savedSettings);
      }
    } catch (e) {
      console.log('Could not load settings from localStorage:', e);
    }

    // DOM elements - Main UI
    const localTimeEl = document.getElementById('local-time');
    const easternTimeEl = document.getElementById('eastern-time');
    const currentPhaseEl = document.getElementById('current-phase');
    const currentPhaseEmojiEl = document.getElementById('current-phase-emoji');
    const currentPhaseIcon2El = document.getElementById('current-phase-icon2');
    const currentPhaseTitleEl = document.getElementById('current-phase-title');
    const currentPhaseTimeEl = document.getElementById('current-phase-time');
    const currentPhaseDescriptionEl = document.getElementById('current-phase-description');
    const currentSubphaseEl = document.getElementById('current-subphase');
    const currentSubphaseTimeEl = document.getElementById('current-subphase-time');
    const phaseTimeRemainingEl = document.getElementById('phase-time-remaining');
    const phaseProgressEl = document.getElementById('phase-progress');
    const phaseStartTimeEl = document.getElementById('phase-start-time');
    const phaseEndTimeEl = document.getElementById('phase-end-time');
    const subphasesContainerEl = document.getElementById('subphases-container');
    const currentPhaseTipsEl = document.getElementById('current-phase-tips');
    const nextPhaseNameEl = document.getElementById('next-phase-name');
    const nextPhaseEmojiEl = document.getElementById('next-phase-emoji');
    const nextPhaseTimeEl = document.getElementById('next-phase-time');
    const timeUntilNextPhaseEl = document.getElementById('time-until-next-phase');
    const scheduleTableBodyEl = document.getElementById('schedule-table-body');
    const timelineIndicatorsEl = document.getElementById('timeline-indicators');
    const timelineDetailsEl = document.getElementById('timeline-details');
    
    // DOM elements - Journal
    const journalDateEl = document.getElementById('journal-date');
    const currentJournalDateEl = document.getElementById('current-journal-date');
    const journalTimeEl = document.getElementById('journal-time');
    const journalPhaseEl = document.getElementById('journal-phase');
    const journalNoteEl = document.getElementById('journal-note');
    const journalEntryTypeEl = document.getElementById('journal-entry-type');
    const journalEntryIdEl = document.getElementById('journal-entry-id');
    const saveJournalEntryBtn = document.getElementById('save-journal-entry');
    const saveButtonTextEl = document.getElementById('save-button-text');
    const cancelEditBtn = document.getElementById('cancel-edit');
    const entryTypeBtns = document.querySelectorAll('.entry-type-btn');
    const journalEntriesContainerEl = document.getElementById('journal-entries-container');
    const noEntriesMessageEl = document.getElementById('no-entries-message');
    const entriesDateEl = document.getElementById('entries-date');
    const entriesCountEl = document.getElementById('entries-count');
    const calendarDaysEl = document.getElementById('calendar-days');
    const journalMonthYearEl = document.getElementById('journal-month-year');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const prevDayBtn = document.getElementById('prev-day-btn');
    const todayBtn = document.getElementById('today-btn');
    const nextDayBtn = document.getElementById('next-day-btn');
    const journalSystemTimeEl = document.getElementById('journal-system-time');
    const addTimestampBtn = document.getElementById('add-timestamp-btn');
    const journalSearchEl = document.getElementById('journal-search');
    const searchBtnEl = document.getElementById('search-btn');
    const filteredMessageEl = document.getElementById('filtered-message');
    const filterDescriptionEl = document.getElementById('filter-description');
    const filterBtnEl = document.getElementById('filter-btn');
    const filterMenuEl = document.getElementById('filter-menu');
    const clearFiltersEl = document.getElementById('clear-filters');
    const applyFiltersEl = document.getElementById('apply-filters');
    const filterTypeBtns = document.querySelectorAll('.filter-type-btn');
    const phaseFilterEl = document.getElementById('phase-filter');
    const tagFilterInputEl = document.getElementById('tag-filter-input');
    const tagFilterContainerEl = document.getElementById('tag-filter-container');
    const journalFormContainerEl = document.getElementById('journal-form-container');
    const formTitleEl = document.getElementById('form-title');
    const newEntryIconEl = document.querySelector('.new-entry-icon');
    const editEntryIconEl = document.querySelector('.edit-entry-icon');
    
    // DOM elements - Journal Tags
    const journalTagInputEl = document.getElementById('journal-tag-input');
    const addTagBtnEl = document.getElementById('add-tag-btn');
    const journalTagsContainerEl = document.getElementById('journal-tags-container');
    
    // DOM elements - Journal image upload
    const imageUploadEl = document.getElementById('journal-image-upload');
    const imageFileNameEl = document.getElementById('image-file-name');
    const imagePreviewsContainerEl = document.getElementById('image-previews-container');
    const imageFullscreenModalEl = document.getElementById('image-fullscreen-modal');
    const fullscreenImageEl = document.getElementById('fullscreen-image');
    const closeFullscreenImageBtn = document.getElementById('close-fullscreen-image');
    const fullscreenThumbnailsEl = document.getElementById('fullscreen-thumbnails');
    
    // DOM elements - Analytics
    const analyticsTabBtn = document.getElementById('analytics-tab');
    const analyticsTabContentEl = document.getElementById('analytics-tab-content');
    const analyticsStartDateEl = document.getElementById('analytics-start-date');
    const analyticsEndDateEl = document.getElementById('analytics-end-date');
    const updateAnalyticsBtn = document.getElementById('update-analytics');
    const presetBtns = document.querySelectorAll('.preset-btn');
    
    // Analytics summary elements
    const totalEntriesEl = document.getElementById('total-entries');
    const entriesTrendEl = document.getElementById('entries-trend');
    const mostActivePhaseEl = document.getElementById('most-active-phase');
    const mostActivePhaseCountEl = document.getElementById('most-active-phase-count');
    const mostActivePhaseIconEl = document.getElementById('most-active-phase-icon');
    const activePhasePercentageEl = document.getElementById('active-phase-percentage');
    const topEntryTypeEl = document.getElementById('top-entry-type');
    const topEntryTypeCountEl = document.getElementById('top-entry-type-count');
    const topEntryTypeIconEl = document.getElementById('top-entry-type-icon');
    const entryTypePercentageEl = document.getElementById('entry-type-percentage');
    const topTagEl = document.getElementById('top-tag');
    const topTagCountEl = document.getElementById('top-tag-count');
    const popularTagsEl = document.getElementById('popular-tags');
    
    // Chart containers
    const phaseDistributionChartEl = document.getElementById('phase-distribution-chart');
    const activityChartEl = document.getElementById('activity-chart');
    const entryTypesChartEl = document.getElementById('entry-types-chart');
    const tagCloudEl = document.getElementById('tag-cloud');
    
    // Recent entries table
    const recentEntriesTableEl = document.getElementById('recent-entries-table');
    
    // Export buttons
    const exportJsonBtnEl = document.getElementById('export-json-btn');
    const exportCsvBtnEl = document.getElementById('export-csv-btn');
    const printReportBtnEl = document.getElementById('print-report-btn');
    
    // DOM elements - Journal data management
    const exportJournalBtn = document.getElementById('export-journal');
    const importJournalBtn = document.getElementById('import-journal');
    const clearJournalBtn = document.getElementById('clear-journal');
    const exportModalEl = document.getElementById('export-modal');
    const importModalEl = document.getElementById('import-modal');
    const closeExportModalBtn = document.getElementById('close-export-modal');
    const closeImportModalBtn = document.getElementById('close-import-modal');
    const exportDataEl = document.getElementById('export-data');
    const importDataEl = document.getElementById('import-data');
    const importFileEl = document.getElementById('import-file');
    const importFileNameEl = document.getElementById('import-file-name');
    const importMergeEl = document.getElementById('import-merge');
    const importReplaceEl = document.getElementById('import-replace');
    const confirmImportBtn = document.getElementById('confirm-import');
    const copyExportDataBtn = document.getElementById('copy-export-data');
    const downloadExportDataBtn = document.getElementById('download-export-data');
    const clearJournalModalEl = document.getElementById('clear-journal-modal');
    const closeClearModalBtn = document.getElementById('close-clear-modal');
    const cancelClearBtn = document.getElementById('cancel-clear');
    const confirmClearBtn = document.getElementById('confirm-clear');
    
    // DOM elements - Entry deletion
    const deleteModalEl = document.getElementById('delete-modal');
    const closeDeleteModalBtn = document.getElementById('close-delete-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    let currentEntryToDelete = null;
    
    // DOM elements - Notifications and settings
    const notificationToastEl = document.getElementById('notification-toast');
    const notificationToastTextEl = document.getElementById('notification-toast-text');
    const notificationSoundIndicatorEl = document.getElementById('notification-sound-indicator');
    const closeNotificationBtn = document.getElementById('close-notification');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModalEl = document.getElementById('settings-modal');
    const closeSettingsBtn = document.getElementById('close-settings');
    const saveSettingsBtn = document.getElementById('save-settings');
    const notificationToggleBtn = document.getElementById('notification-toggle');
    const notificationBadgeEl = document.getElementById('notification-badge');
    
    // Tab elements
    const overviewTabBtn = document.getElementById('overview-tab');
    const scheduleTabBtn = document.getElementById('schedule-tab');
    const tradingTabBtn = document.getElementById('trading-tab');
    const journalTabBtn = document.getElementById('journal-tab');
    const overviewContentEl = document.getElementById('overview-content');
    const scheduleContentEl = document.getElementById('schedule-content');
    const tradingTabContentEl = document.getElementById('trading-tab-content');
    const journalTabContentEl = document.getElementById('journal-tab-content');

    // Settings form elements
    const enableNotificationsToggle = document.getElementById('enable-notifications');
    const phaseChangeAlertToggle = document.getElementById('phase-change-alert');
    const subphaseChangeAlertToggle = document.getElementById('subphase-change-alert');
    const soundAlertsToggle = document.getElementById('sound-alerts');
    const advancedWarningToggle = document.getElementById('advanced-warning');
    const showTimelineToggle = document.getElementById('show-timeline');
    const showBestWindowsToggle = document.getElementById('show-best-windows');
    const showAnalyticsToggle = document.getElementById('show-analytics');
    const journalRemindersToggle = document.getElementById('journal-reminders');
    const autoTagToggle = document.getElementById('auto-tag');

    // Journal state variables
    let currentJournalDate = new Date();
    let displayedMonth = new Date();
    let journalData = {};
    let journalReminderShown = false;
    let currentImageFiles = []; // Array to store multiple image files
    let currentJournalTags = [];
    let currentSearchText = '';
    let currentFilterType = 'all';
    let currentFilterPhase = 'all';
    let currentFilterTags = [];
    let isFiltered = false;
    let isEditMode = false; // Track if we're editing an entry

    // Chart objects
    let phaseDistributionChart = null;
    let activityChart = null;
    let entryTypesChart = null;

    // Analytics date range
    let analyticsDateRange = {
      start: new Date(new Date().getFullYear(), new Date().getMonth() - 3, 1),
      end: new Date()
    };

    // Last notified phase to prevent duplicate notifications
    let lastNotifiedPhaseId = null;
    let lastNotifiedSubphaseId = null;
    let advancedWarningTriggered = false;

    // Initialize settings form
    function initSettingsForm() {
      enableNotificationsToggle.checked = userSettings.notifications.enabled;
      phaseChangeAlertToggle.checked = userSettings.notifications.phaseChange;
      subphaseChangeAlertToggle.checked = userSettings.notifications.subphaseChange;
      soundAlertsToggle.checked = userSettings.notifications.soundAlerts;
      advancedWarningToggle.checked = userSettings.notifications.advancedWarning;
      showTimelineToggle.checked = userSettings.display.showTimeline;
      showBestWindowsToggle.checked = userSettings.display.showBestWindows;
      showAnalyticsToggle.checked = userSettings.display.showAnalytics !== false;
      journalRemindersToggle.checked = userSettings.journal?.reminders !== false;
      autoTagToggle.checked = userSettings.journal?.autoTag !== false;
    }

    // Create an audio context for sound notifications
    let audioContext;
    function initAudioContext() {
      try {
        // Create an audio context on user interaction to comply with autoplay policies
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) {
        console.log('Web Audio API is not supported in this browser');
      }
    }

    // Play notification sound
    function playNotificationSound() {
      if (!audioContext || !userSettings.notifications.soundAlerts) return;
      
      try {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(587.33, audioContext.currentTime); // D5
        oscillator.frequency.setValueAtTime(880, audioContext.currentTime + 0.2); // A5
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.5);
        
        // Show sound indicator
        notificationSoundIndicatorEl.classList.remove('hidden');
        setTimeout(() => {
          notificationSoundIndicatorEl.classList.add('hidden');
        }, 2000);
      } catch (e) {
        console.log('Error playing notification sound:', e);
      }
    }

    // Convert local time to Eastern Time
    function getEasternTime() {
      const now = new Date();
      
      // Create a date object for the current time in the local timezone
      const localTime = new Date();
      
      // Get the time zone offset for Eastern Time (ET)
      // ET is UTC-5 during standard time and UTC-4 during daylight saving time
      
      // Determine if DST is in effect in Eastern Time
      const jan = new Date(now.getFullYear(), 0, 1);
      const jul = new Date(now.getFullYear(), 6, 1);
      const stdTimezoneOffset = Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
      const isDST = now.getTimezoneOffset() < stdTimezoneOffset;
      
      // Eastern Time is UTC-5 during standard time and UTC-4 during DST
      const etOffset = isDST ? -4 : -5;
      
      // Calculate the time difference between local and Eastern Time
      const localOffset = -now.getTimezoneOffset() / 60; // Convert minutes to hours and invert
      const diffFromET = localOffset - etOffset;
      
      // Adjust the local time to get Eastern Time
      const easternTime = new Date(localTime.getTime() - (diffFromET * 60 * 60 * 1000));
      
      return easternTime;
    }

    // Format time as HH:MM AM/PM
    function formatTime(date) {
      let hours = date.getHours();
      const minutes = date.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      
      hours = hours % 12;
      hours = hours ? hours : 12; // Convert 0 to 12
      
      const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
      
      return `${hours}:${formattedMinutes} ${ampm}`;
    }

    // Format time with seconds as HH:MM:SS
    function formatTimeWithSeconds(date) {
      let hours = date.getHours();
      const minutes = date.getMinutes();
      const seconds = date.getSeconds();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      
      hours = hours % 12;
      hours = hours ? hours : 12; // Convert 0 to 12
      
      const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
      const formattedSeconds = seconds < 10 ? '0' + seconds : seconds;
      
      return `${hours}:${formattedMinutes}:${formattedSeconds} ${ampm}`;
    }

    // Format time from hours and minutes object
    function formatTimeFromObj(timeObj) {
      let hours = timeObj.hours;
      const minutes = timeObj.minutes;
      const ampm = hours >= 12 ? 'PM' : 'AM';
      
      hours = hours % 12;
      hours = hours ? hours : 12; // Convert 0 to 12
      
      const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
      
      return `${hours}:${formattedMinutes} ${ampm}`;
    }

    // Format date as YYYY-MM-DD
    function formatDateISO(date) {
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Format date for display (e.g., "Mar 15, 2023")
    function formatDateDisplay(date) {
      const options = { month: 'short', day: 'numeric', year: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    // Format month and year for display (e.g., "March 2023")
    function formatMonthYear(date) {
      const options = { month: 'long', year: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    // Parse time string like "8:30 AM" to hours and minutes
    function parseTimeString(timeString) {
      const [timePart, ampm] = timeString.split(' ');
      let [hours, minutes] = timePart.split(':').map(Number);
      
      if (ampm === 'PM' && hours < 12) hours += 12;
      if (ampm === 'AM' && hours === 12) hours = 0;
      
      return { hours, minutes };
    }

    // Format minutes as HH:MM
    function formatMinutesAsTime(totalMinutes) {
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      
      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      } else {
        return `${minutes}m`;
      }
    }

    // Get current market phase based on the time
    function getCurrentPhase(date) {
      const hours = date.getHours();
      const minutes = date.getMinutes();
      const totalMinutes = hours * 60 + minutes;
      
      // Check each phase to see if the current time falls within its range
      for (const phase of marketPhases) {
        const startTotalMinutes = phase.timeStart.hours * 60 + phase.timeStart.minutes;
        const endTotalMinutes = phase.timeEnd.hours * 60 + phase.timeEnd.minutes;
        
        // Handle phases that cross midnight
        if (startTotalMinutes > endTotalMinutes) {
          // If the current time is after the start time OR before the end time
          if (totalMinutes >= startTotalMinutes || totalMinutes < endTotalMinutes) {
            return phase;
          }
        } else {
          // Normal case (start time before end time)
          if (totalMinutes >= startTotalMinutes && totalMinutes < endTotalMinutes) {
            return phase;
          }
        }
      }
      
      // Fallback (should not happen with complete coverage)
      return marketPhases[0];
    }

    // Get current subphase based on the time and current phase
    function getCurrentSubphase(date, currentPhase) {
      if (!currentPhase.subphases) return null;
      
      const hours = date.getHours();
      const minutes = date.getMinutes();
      const totalMinutes = hours * 60 + minutes;
      
      for (const subphase of currentPhase.subphases) {
        const [startTime, endTime] = subphase.timeRange.split(' - ');
        const startObj = parseTimeString(startTime);
        const endObj = parseTimeString(endTime);
        
        const startTotalMinutes = startObj.hours * 60 + startObj.minutes;
        const endTotalMinutes = endObj.hours * 60 + endObj.minutes;
        
        // Handle subphases that cross midnight (unlikely but for completeness)
        if (startTotalMinutes > endTotalMinutes) {
          if (totalMinutes >= startTotalMinutes || totalMinutes < endTotalMinutes) {
            return subphase;
          }
        } else {
          if (totalMinutes >= startTotalMinutes && totalMinutes < endTotalMinutes) {
            return subphase;
          }
        }
      }
      
      return null;
    }

    // Get next market phase
    function getNextPhase(currentPhase) {
      const currentIndex = marketPhases.findIndex(phase => phase.id === currentPhase.id);
      const nextIndex = (currentIndex + 1) % marketPhases.length;
      return marketPhases[nextIndex];
    }

    // Calculate time until next phase in minutes
    function getTimeUntilNextPhase(currentTime, nextPhase) {
      const currentHours = currentTime.getHours();
      const currentMinutes = currentTime.getMinutes();
      const currentTotalMinutes = currentHours * 60 + currentMinutes;
      
      const nextPhaseStartHours = nextPhase.timeStart.hours;
      const nextPhaseStartMinutes = nextPhase.timeStart.minutes;
      let nextPhaseTotalMinutes = nextPhaseStartHours * 60 + nextPhaseStartMinutes;
      
      // Handle phases that cross midnight
      if (nextPhaseTotalMinutes < currentTotalMinutes) {
        nextPhaseTotalMinutes += 24 * 60; // Add 24 hours
      }
      
      return nextPhaseTotalMinutes - currentTotalMinutes;
    }

    // Calculate phase progress percentage
    function getPhaseProgress(currentTime, currentPhase) {
      const currentHours = currentTime.getHours();
      const currentMinutes = currentTime.getMinutes();
      const currentTotalMinutes = currentHours * 60 + currentMinutes;
      
      const phaseStartHours = currentPhase.timeStart.hours;
      const phaseStartMinutes = currentPhase.timeStart.minutes;
      let phaseStartTotalMinutes = phaseStartHours * 60 + phaseStartMinutes;
      
      const phaseEndHours = currentPhase.timeEnd.hours;
      const phaseEndMinutes = currentPhase.timeEnd.minutes;
      let phaseEndTotalMinutes = phaseEndHours * 60 + phaseEndMinutes;
      
      // Handle phases that cross midnight
      if (phaseEndTotalMinutes < phaseStartTotalMinutes) {
        // If the current time is after midnight but before the end time
        if (currentTotalMinutes < phaseEndTotalMinutes) {
          // Add 24 hours to start time for calculation
          phaseStartTotalMinutes -= 24 * 60;
        } else {
          // Add 24 hours to end time for calculation
          phaseEndTotalMinutes += 24 * 60;
        }
      }
      
      const elapsed = currentTotalMinutes - phaseStartTotalMinutes;
      const duration = phaseEndTotalMinutes - phaseStartTotalMinutes;
      
      return Math.floor((elapsed / duration) * 100);
    }

    // Calculate time remaining in current phase in minutes
    function getTimeRemainingInPhase(currentTime, currentPhase) {
      const currentHours = currentTime.getHours();
      const currentMinutes = currentTime.getMinutes();
      const currentTotalMinutes = currentHours * 60 + currentMinutes;
      
      const phaseEndHours = currentPhase.timeEnd.hours;
      const phaseEndMinutes = currentPhase.timeEnd.minutes;
      let phaseEndTotalMinutes = phaseEndHours * 60 + phaseEndMinutes;
      
      // Handle phases that cross midnight
      if (phaseEndTotalMinutes < currentTotalMinutes) {
        phaseEndTotalMinutes += 24 * 60; // Add 24 hours
      }
      
      return phaseEndTotalMinutes - currentTotalMinutes;
    }

    // Show notification
    function showNotification(message, isPhaseChange = true, isSubphaseChange = false) {
      if (!userSettings.notifications.enabled) return;
      if (isPhaseChange && !userSettings.notifications.phaseChange) return;
      if (isSubphaseChange && !userSettings.notifications.subphaseChange) return;
      
      notificationToastTextEl.textContent = message;
      notificationToastEl.classList.remove('translate-y-20', 'opacity-0');
      
      if (userSettings.notifications.soundAlerts) {
        playNotificationSound();
      }
      
      // Hide notification after 8 seconds
      setTimeout(() => {
        notificationToastEl.classList.add('translate-y-20', 'opacity-0');
      }, 8000);
    }

    // Generate subphases for current phase
    function generateSubphases(phase, currentTime) {
      subphasesContainerEl.innerHTML = '';
      
      if (!phase.subphases) return;
      
      const currentSubphase = getCurrentSubphase(currentTime, phase);
      
      phase.subphases.forEach(subphase => {
        const isActive = currentSubphase && subphase.id === currentSubphase.id;
        
        const subphaseEl = document.createElement('div');
        subphaseEl.className = `sub-phase px-3 py-2 rounded-r-lg ${isActive ? 'active bg-primary/10 dark:bg-primary-dark/20' : ''}`;
        subphaseEl.innerHTML = `
          <div class="flex justify-between items-center">
            <h3 class="font-medium ${isActive ? 'text-primary dark:text-primary-light' : ''}">${subphase.name}</h3>
            <span class="text-xs text-gray-500 dark:text-gray-400">${subphase.timeRange}</span>
          </div>
          <div class="mt-1 space-y-1 text-sm">
            <p><span class="font-medium">Behavior:</span> ${subphase.behavior}</p>
            <p><span class="font-medium">Key Notes:</span> ${subphase.keyNotes}</p>
          </div>
        `;
        
        subphasesContainerEl.appendChild(subphaseEl);
      });
      
      // Update current subphase display
      if (currentSubphase) {
        currentSubphaseEl.textContent = currentSubphase.name;
        currentSubphaseTimeEl.textContent = currentSubphase.timeRange;
      } else {
        currentSubphaseEl.textContent = "N/A";
        currentSubphaseTimeEl.textContent = "";
      }
      
      // Notify of subphase change
      if (currentSubphase && userSettings.notifications.subphaseChange && lastNotifiedSubphaseId !== currentSubphase.id) {
        lastNotifiedSubphaseId = currentSubphase.id;
        showNotification(`New subphase: ${currentSubphase.name} (${currentSubphase.timeRange})`, false, true);
      }
    }

    // Generate trading tips HTML for current phase
    function generateTradingTips(phase) {
      if (!phase.tradingTips || phase.tradingTips.length === 0) {
        return '<p>No specific trading tips for this phase.</p>';
      }
      
      return `
        <ul class="space-y-1 list-disc pl-5">
          ${phase.tradingTips.map(tip => `<li>${tip}</li>`).join('')}
        </ul>
      `;
    }

    // Tab switching
    function switchTab(tabId) {
      // Hide all tab content
      overviewContentEl.classList.add('hidden');
      scheduleContentEl.classList.add('hidden');
      tradingTabContentEl.classList.add('hidden');
      journalTabContentEl.classList.add('hidden');
      analyticsTabContentEl.classList.add('hidden');
      
      // Remove active class from all tabs
      overviewTabBtn.classList.remove('active');
      scheduleTabBtn.classList.remove('active');
      tradingTabBtn.classList.remove('active');
      journalTabBtn.classList.remove('active');
      analyticsTabBtn.classList.remove('active');
      
      // Show selected tab content and set active class
      if (tabId === 'overview') {
        overviewContentEl.classList.remove('hidden');
        overviewTabBtn.classList.add('active');
      } else if (tabId === 'schedule') {
        scheduleContentEl.classList.remove('hidden');
        scheduleTabBtn.classList.add('active');
        generateScheduleTable(); // Refresh the table when tab is shown
      } else if (tabId === 'trading') {
        tradingTabContentEl.classList.remove('hidden');
        tradingTabBtn.classList.add('active');
      } else if (tabId === 'journal') {
        journalTabContentEl.classList.remove('hidden');
        journalTabBtn.classList.add('active');
        updateJournalUI(); // Refresh journal UI when tab is shown
      } else if (tabId === 'analytics') {
        analyticsTabContentEl.classList.remove('hidden');
        analyticsTabBtn.classList.add('active');
        updateAnalytics(); // Update analytics when tab is shown
      }
    }

    // Generate complete schedule table
    function generateScheduleTable() {
      scheduleTableBodyEl.innerHTML = '';
      
      const easternTime = getEasternTime();
      const currentPhase = getCurrentPhase(easternTime);
      const currentSubphase = getCurrentSubphase(easternTime, currentPhase);
      
      // Flatten all subphases into a single array
      const allTimeSlots = [];
      
      marketPhases.forEach(phase => {
        phase.subphases.forEach(subphase => {
          allTimeSlots.push({
            phaseId: phase.id,
            phaseName: phase.name,
            subphaseId: subphase.id,
            timeRange: subphase.timeRange,
            behavior: subphase.behavior,
            keyNotes: subphase.keyNotes
          });
        });
      });
      
      // Sort time slots by time
      allTimeSlots.sort((a, b) => {
        const [aStartTime] = a.timeRange.split(' - ');
        const [bStartTime] = b.timeRange.split(' - ');
        
        const aStartObj = parseTimeString(aStartTime);
        const bStartObj = parseTimeString(bStartTime);
        
        const aStartMinutes = aStartObj.hours * 60 + aStartObj.minutes;
        const bStartMinutes = bStartObj.hours * 60 + bStartObj.minutes;
        
        // Handle overnight comparison
        if (aStartMinutes >= 1200 && bStartMinutes < 240) return -1; // a is evening, b is early morning
        if (aStartMinutes < 240 && bStartMinutes >= 1200) return 1; // a is early morning, b is evening
        
        return aStartMinutes - bStartMinutes;
      });
      
      // Create table rows
      allTimeSlots.forEach(slot => {
        const isActive = currentSubphase && slot.subphaseId === currentSubphase.id;
        
        const row = document.createElement('tr');
        row.className = `border-b dark:border-gray-700 ${isActive ? 'schedule-row active' : 'hover:bg-gray-50 dark:hover:bg-gray-700'}`;
        
        row.innerHTML = `
          <td class="px-4 py-3 font-medium ${isActive ? 'text-primary dark:text-primary-light' : ''}">${slot.timeRange}</td>
          <td class="px-4 py-3">${slot.phaseName}</td>
          <td class="px-4 py-3">${slot.behavior}</td>
          <td class="px-4 py-3">${slot.keyNotes}</td>
        `;
        
        scheduleTableBodyEl.appendChild(row);
      });
    }

    // Update the UI with current phase information
    function updatePhaseInfo(phase, easternTime) {
      // Update phase basics
      currentPhaseEl.textContent = phase.name;
      currentPhaseEmojiEl.textContent = phase.emoji;
      currentPhaseIcon2El.textContent = phase.emoji;
      currentPhaseTitleEl.textContent = phase.name;
      currentPhaseTimeEl.textContent = phase.timeRange;
      currentPhaseDescriptionEl.textContent = phase.description;
      
      // Update trading tips
      currentPhaseTipsEl.innerHTML = generateTradingTips(phase);
      
      // Update progress information
      const progress = getPhaseProgress(easternTime, phase);
      phaseProgressEl.style.width = `${progress}%`;
      
      // Update phase time range
      phaseStartTimeEl.textContent = formatTimeFromObj(phase.timeStart);
      phaseEndTimeEl.textContent = formatTimeFromObj(phase.timeEnd);
      
      // Calculate and update time remaining
      const timeRemaining = getTimeRemainingInPhase(easternTime, phase);
      phaseTimeRemainingEl.textContent = formatMinutesAsTime(timeRemaining);
      
      // Get next phase information
      const nextPhase = getNextPhase(phase);
      const timeUntilNext = getTimeUntilNextPhase(easternTime, nextPhase);
      
      // Update next phase information
      nextPhaseNameEl.textContent = nextPhase.name;
      nextPhaseEmojiEl.textContent = nextPhase.emoji;
      nextPhaseTimeEl.textContent = nextPhase.timeRange;
      timeUntilNextPhaseEl.textContent = formatMinutesAsTime(timeUntilNext);
      
      // Generate subphases
      generateSubphases(phase, easternTime);
      
      // Check for advanced warning (5 minutes before phase change)
      if (timeRemaining <= 5 && !advancedWarningTriggered && userSettings.notifications.advancedWarning) {
        showNotification(`In ${timeRemaining} minutes: ${nextPhase.name} ${nextPhase.emoji}`, false);
        advancedWarningTriggered = true;
      } else if (timeRemaining > 5) {
        advancedWarningTriggered = false;
      }
      
      // Notify if phase has changed
      if (lastNotifiedPhaseId !== phase.id) {
        lastNotifiedPhaseId = phase.id;
        showNotification(`New phase: ${phase.emoji} ${phase.name}`);
      }
      
      // Highlight current phase in timeline
      document.querySelectorAll('[id^="timeline-dot-"]').forEach(el => {
        const phaseId = el.id.replace('timeline-dot-', '');
        
        if (phaseId === phase.id) {
          el.classList.add('bg-primary', 'scale-125');
          el.classList.remove('bg-gray-300', 'dark:bg-gray-600');
        } else {
          el.classList.remove('bg-primary', 'scale-125');
          el.classList.add('bg-gray-300', 'dark:bg-gray-600');
        }
      });
      
      document.querySelectorAll('[id^="timeline-label-"]').forEach(el => {
        const phaseId = el.id.replace('timeline-label-', '');
        
        if (phaseId === phase.id) {
          el.classList.add('text-primary', 'dark:text-primary-light', 'font-medium');
        } else {
          el.classList.remove('text-primary', 'dark:text-primary-light', 'font-medium');
        }
      });
      
      // Update schedule table highlighting
      if (scheduleContentEl.classList.contains('hidden')) {
        // Only regenerate the table if the tab is visible, to save performance
        generateScheduleTable();
      }
      
      // Update journal form with current phase
      if (!journalTabContentEl.classList.contains('hidden')) {
        const currentSubphase = getCurrentSubphase(easternTime, phase);
        const phaseInfo = `${phase.emoji} ${phase.name}`;
        const subphaseInfo = currentSubphase ? ` | ${currentSubphase.name}` : '';
        journalPhaseEl.textContent = phaseInfo + subphaseInfo;
        journalTimeEl.textContent = formatTime(easternTime);
      }
      
      // Show journal reminder if needed
      const todayStr = formatDateISO(new Date());
      if (!journalReminderShown && !journalData[todayStr] && 
          userSettings.journal.reminders !== false && 
          [9, 13, 16].includes(easternTime.getHours()) && 
          easternTime.getMinutes() === 0) {
        showNotification('📝 Time for a trading journal entry! Record your thoughts or trades for this phase.', false);
        journalReminderShown = true;
        
        // Reset the reminder after 5 minutes
        setTimeout(() => {
          journalReminderShown = false;
        }, 5 * 60 * 1000);
      }
    }

    // Generate the timeline UI
    function generateTimeline() {
      // Clear existing content
      timelineIndicatorsEl.innerHTML = '';
      timelineDetailsEl.innerHTML = '';
      
      // Create timeline dots and labels
      marketPhases.forEach((phase, index) => {
        // Create timeline dot
        const timelineDot = document.createElement('div');
        timelineDot.className = 'relative';
        timelineDot.style.flex = '1';
        timelineDot.innerHTML = `
          <div id="timeline-dot-${phase.id}" class="timeline-dot absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-4 h-4 rounded-full bg-gray-300 dark:bg-gray-600 z-10"></div>
          <div class="absolute top-6 left-1/2 transform -translate-x-1/2 text-xs text-gray-600 dark:text-gray-400 whitespace-nowrap">
            ${formatTimeFromObj(phase.timeStart)}
          </div>
        `;
        timelineIndicatorsEl.appendChild(timelineDot);
        
        // Add end time for the last phase
        if (index === marketPhases.length - 1) {
          const endTime = document.createElement('div');
          endTime.className = 'absolute top-6 right-0 text-xs text-gray-600 dark:text-gray-400 whitespace-nowrap';
          endTime.textContent = formatTimeFromObj(phase.timeEnd);
          timelineIndicatorsEl.appendChild(endTime);
        }
        
        // Create timeline details
        const timelineDetail = document.createElement('div');
        timelineDetail.className = 'text-center';
        timelineDetail.innerHTML = `
          <p id="timeline-label-${phase.id}" class="text-xs font-normal flex justify-center items-center">
            <span class="mr-1">${phase.emoji}</span>
            ${phase.shortName}
          </p>
        `;
        timelineDetailsEl.appendChild(timelineDetail);
      });
    }

    // Journal functions
    
    // Load journal data from localStorage
    function loadJournalData() {
      try {
        const savedData = localStorage.getItem('nasdaq-journal-data');
        if (savedData) {
          journalData = JSON.parse(savedData);
          
          // Post-process older entries to ensure they have tags field
          Object.keys(journalData).forEach(date => {
            journalData[date].forEach(entry => {
              if (!entry.tags) {
                entry.tags = [];
              }
              
              // Convert older entries with single imageData to array format
              if (entry.imageData && !entry.imageFiles) {
                entry.imageFiles = [entry.imageData];
                entry.imageData = undefined; // Clear old format
              }
            });
          });
        }
      } catch (e) {
        console.log('Could not load journal data from localStorage:', e);
        journalData = {};
      }
    }
    
    // Save journal data to localStorage
    function saveJournalData() {
      try {
        localStorage.setItem('nasdaq-journal-data', JSON.stringify(journalData));
      } catch (e) {
        console.log('Could not save journal data to localStorage:', e);
        showNotification('Error saving journal data. Local storage may be full.', false);
      }
    }
    
    // Generate a unique ID for journal entries
    function generateEntryId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }
    
    // Get entries for a specific date
    function getEntriesForDate(date) {
      const dateStr = formatDateISO(date);
      return journalData[dateStr] || [];
    }
    
    // Auto-generate tags based on note content
    function autoGenerateTags(noteText) {
      if (!userSettings.journal.autoTag) return [];
      
      const generatedTags = [];
      
      // Check for market terms
      marketTerms.forEach(({ term, tag }) => {
        if (noteText.toLowerCase().includes(term.toLowerCase()) && !generatedTags.includes(tag)) {
          generatedTags.push(tag);
        }
      });
      
      // Add market phase tag if not already included
      const easternTime = getEasternTime();
      const currentPhase = getCurrentPhase(easternTime);
      const phaseTag = currentPhase.id;
      
      if (!generatedTags.includes(phaseTag)) {
        generatedTags.push(phaseTag);
      }
      
      return generatedTags;
    }
    
    // Update the calendar display
    function updateCalendar() {
      // Update month/year display
      journalMonthYearEl.textContent = formatMonthYear(displayedMonth);
      
      // Clear existing calendar days
      calendarDaysEl.innerHTML = '';
      
      // Get the first day of the month
      const firstDay = new Date(displayedMonth.getFullYear(), displayedMonth.getMonth(), 1);
      const lastDay = new Date(displayedMonth.getFullYear(), displayedMonth.getMonth() + 1, 0);
      
      // Get the day of week for the first day (0 = Sunday)
      const firstDayOfWeek = firstDay.getDay();
      
      // Add empty cells for days before the first day of month
      for (let i = 0; i < firstDayOfWeek; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-day opacity-0';
        calendarDaysEl.appendChild(emptyCell);
      }
      
      // Get today's date for highlighting
      const today = new Date();
      const todayStr = formatDateISO(today);
      
      // Get selected date
      const selectedDateStr = formatDateISO(currentJournalDate);
      
      // Add days of the month
      for (let i = 1; i <= lastDay.getDate(); i++) {
        const dayDate = new Date(displayedMonth.getFullYear(), displayedMonth.getMonth(), i);
        const dateStr = formatDateISO(dayDate);
        
        // Check if this date has entries
        const hasEntries = journalData[dateStr] && journalData[dateStr].length > 0;
        
        // Check if this is today
        const isToday = dateStr === todayStr;
        
        // Check if this is the selected date
        const isSelected = dateStr === selectedDateStr;
        
        const dayCell = document.createElement('div');
        dayCell.className = `calendar-day ${isSelected ? 'selected' : ''} ${hasEntries ? 'has-entries' : ''} ${isToday && !isSelected ? 'today' : ''}`;
        dayCell.textContent = i;
        dayCell.dataset.date = dateStr;
        
        // Add click event to select date
        dayCell.addEventListener('click', () => {
          selectJournalDate(new Date(dateStr));
        });
        
        calendarDaysEl.appendChild(dayCell);
      }
    }
    
    // Select a date and update the journal UI
    function selectJournalDate(date) {
      currentJournalDate = date;
      
      // Update the date input
      journalDateEl.value = formatDateISO(date);
      
      // Update the displayed date
      currentJournalDateEl.textContent = formatDateDisplay(date);
      entriesDateEl.textContent = formatDateDisplay(date);
      
      // Update calendar if the month has changed
      if (date.getMonth() !== displayedMonth.getMonth() || 
          date.getFullYear() !== displayedMonth.getFullYear()) {
        displayedMonth = new Date(date.getFullYear(), date.getMonth(), 1);
        updateCalendar();
      } else {
        // Just update the selected day highlight
        document.querySelectorAll('.calendar-day').forEach(day => {
          if (day.dataset.date === formatDateISO(date)) {
            day.classList.add('selected');
          } else {
            day.classList.remove('selected');
          }
        });
      }
      
      // Reset filters and search
      resetFilters();
      
      // Load and display entries for this date
      displayJournalEntries();
    }
    
    // Filter journal entries
    function filterJournalEntries() {
      const dateStr = formatDateISO(currentJournalDate);
      let entries = journalData[dateStr] || [];
      
      // Apply type filter
      if (currentFilterType !== 'all') {
        entries = entries.filter(entry => entry.type === currentFilterType);
      }
      
      // Apply phase filter
      if (currentFilterPhase !== 'all') {
        entries = entries.filter(entry => {
          const phaseInfo = entry.phase || '';
          return phaseInfo.toLowerCase().includes(currentFilterPhase);
        });
      }
      
      // Apply tag filters
      if (currentFilterTags.length > 0) {
        entries = entries.filter(entry => {
          const entryTags = entry.tags || [];
          return currentFilterTags.some(tag => entryTags.includes(tag));
        });
      }
      
      // Apply search text
      if (currentSearchText) {
        const searchLower = currentSearchText.toLowerCase();
        entries = entries.filter(entry => {
          return entry.note.toLowerCase().includes(searchLower) || 
                 (entry.tags && entry.tags.some(tag => tag.toLowerCase().includes(searchLower)));
        });
      }
      
      // Update filter status
      isFiltered = currentFilterType !== 'all' || currentFilterPhase !== 'all' || 
                   currentFilterTags.length > 0 || currentSearchText !== '';
      
      if (isFiltered) {
        let filterDesc = [];
        
        if (currentFilterType !== 'all') {
          filterDesc.push(`Type = ${entryTypes[currentFilterType].label}`);
        }
        
        if (currentFilterPhase !== 'all') {
          const phaseName = marketPhases.find(p => p.id === currentFilterPhase)?.name || currentFilterPhase;
          filterDesc.push(`Phase = ${phaseName}`);
        }
        
        if (currentFilterTags.length > 0) {
          filterDesc.push(`Tags = ${currentFilterTags.join(', ')}`);
        }
        
        if (currentSearchText) {
          filterDesc.push(`Search = "${currentSearchText}"`);
        }
        
        filteredMessageEl.classList.remove('hidden');
        filterDescriptionEl.textContent = filterDesc.join(' | ');
        clearFiltersEl.classList.remove('hidden');
      } else {
        filteredMessageEl.classList.add('hidden');
        clearFiltersEl.classList.add('hidden');
      }
      
      return entries;
    }
    
    // Reset all filters
    function resetFilters() {
      currentSearchText = '';
      currentFilterType = 'all';
      currentFilterPhase = 'all';
      currentFilterTags = [];
      isFiltered = false;
      
      // Reset UI elements
      journalSearchEl.value = '';
      phaseFilterEl.value = 'all';
      tagFilterContainerEl.innerHTML = '';
      
      // Reset filter buttons
      filterTypeBtns.forEach(btn => {
        if (btn.dataset.filter === 'all') {
          btn.classList.add('bg-primary', 'text-white');
          btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
        } else {
          btn.classList.remove('bg-primary', 'text-white');
          btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
        }
      });
      
      // Hide filtered message
      filteredMessageEl.classList.add('hidden');
      clearFiltersEl.classList.add('hidden');
    }
    
    // Highlight search terms in text
    function highlightSearchTerms(text) {
      if (!currentSearchText) return text;
      
      const searchTerm = currentSearchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // Escape regex special chars
      const regex = new RegExp(`(${searchTerm})`, 'gi');
      
      return text.replace(regex, '<span class="highlight">$1</span>');
    }
    
    // Enter edit mode for an existing entry
    function editJournalEntry(entryId) {
      // Exit edit mode if already in it
      if (isEditMode) {
        cancelEdit();
      }
      
      const dateStr = formatDateISO(currentJournalDate);
      if (!journalData[dateStr]) return;
      
      const entryIndex = journalData[dateStr].findIndex(entry => entry.id === entryId);
      if (entryIndex === -1) return;
      
      const entry = journalData[dateStr][entryIndex];
      
      // Set edit mode
      isEditMode = true;
      journalFormContainerEl.classList.add('edit-mode');
      
      // Update form title
      formTitleEl.textContent = 'Edit Journal Entry';
      newEntryIconEl.classList.add('hidden');
      editEntryIconEl.classList.remove('hidden');
      
      // Fill the form with entry data
      journalDateEl.value = entry.date;
      journalNoteEl.value = entry.note;
      journalEntryTypeEl.value = entry.type;
      journalEntryIdEl.value = entry.id;
      
      // Set the entry type button state
      entryTypeBtns.forEach(btn => {
        if (btn.dataset.type === entry.type) {
          btn.classList.add('bg-primary', 'text-white', 'border-primary', 'dark:bg-primary-dark', 'dark:border-primary-dark');
        } else {
          btn.classList.remove('bg-primary', 'text-white', 'border-primary', 'dark:bg-primary-dark', 'dark:border-primary-dark');
        }
      });
      
      // Set the tags
      currentJournalTags = [...(entry.tags || [])];
      journalTagsContainerEl.innerHTML = '';
      currentJournalTags.forEach(tag => {
        const tagEl = document.createElement('div');
        tagEl.className = 'tag px-2 py-1 bg-primary/10 dark:bg-primary-dark/20 text-primary dark:text-primary-light rounded text-xs flex items-center';
        tagEl.innerHTML = `
          #${tag}
          <button class="remove-tag-btn ml-1 text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400" data-tag="${tag}">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        journalTagsContainerEl.appendChild(tagEl);
        
        // Add event listener to remove button
        tagEl.querySelector('.remove-tag-btn').addEventListener('click', (e) => {
          const tagToRemove = e.currentTarget.dataset.tag;
          removeTag(tagToRemove);
        });
      });
      
      // Set images if available
      imagePreviewsContainerEl.innerHTML = '';
      if (entry.imageFiles && entry.imageFiles.length > 0) {
        currentImageFiles = [...entry.imageFiles];
        imagePreviewsContainerEl.classList.remove('hidden');
        
        // Create preview for each image
        currentImageFiles.forEach((imageData, index) => {
          const previewItem = document.createElement('div');
          previewItem.className = 'image-preview-item';
          previewItem.innerHTML = `
            <img src="${imageData}" alt="Image preview ${index + 1}">
            <button class="remove-preview-btn" data-index="${index}">
              <i class="fas fa-times"></i>
            </button>
          `;
          imagePreviewsContainerEl.appendChild(previewItem);
          
          // Add event listener to remove button
          previewItem.querySelector('.remove-preview-btn').addEventListener('click', (e) => {
            const index = parseInt(e.currentTarget.dataset.index, 10);
            removeImagePreview(index);
          });
        });
        
        imageFileNameEl.textContent = `${currentImageFiles.length} images selected`;
      } else {
        currentImageFiles = [];
        imagePreviewsContainerEl.classList.add('hidden');
        imageFileNameEl.textContent = 'No files chosen';
      }
      
      // Update button text
      saveButtonTextEl.textContent = 'Update Entry';
      
      // Show cancel button
      cancelEditBtn.classList.remove('hidden');
      
      // Scroll to the form
      journalFormContainerEl.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Cancel entry editing
    function cancelEdit() {
      // Reset edit mode
      isEditMode = false;
      journalFormContainerEl.classList.remove('edit-mode');
      
      // Reset form title
      formTitleEl.textContent = 'New Journal Entry';
      newEntryIconEl.classList.remove('hidden');
      editEntryIconEl.classList.add('hidden');
      
      // Clear form
      journalNoteEl.value = '';
      journalEntryIdEl.value = '';
      
      // Reset entry type to observation
      journalEntryTypeEl.value = 'observation';
      entryTypeBtns.forEach(btn => {
        if (btn.dataset.type === 'observation') {
          btn.classList.add('bg-primary', 'text-white', 'border-primary', 'dark:bg-primary-dark', 'dark:border-primary-dark');
        } else {
          btn.classList.remove('bg-primary', 'text-white', 'border-primary', 'dark:bg-primary-dark', 'dark:border-primary-dark');
        }
      });
      
      // Clear tags
      currentJournalTags = [];
      journalTagsContainerEl.innerHTML = '';
      
      // Clear images
      imageUploadEl.value = '';
      imageFileNameEl.textContent = 'No files chosen';
      imagePreviewsContainerEl.innerHTML = '';
      imagePreviewsContainerEl.classList.add('hidden');
      currentImageFiles = [];
      
      // Reset button text
      saveButtonTextEl.textContent = 'Save Entry';
      
      // Hide cancel button
      cancelEditBtn.classList.add('hidden');
    }
    
    // Display journal entries for the selected date
    function displayJournalEntries() {
      // Apply filters to get entries
      const entries = filterJournalEntries();
      
      // Update entries count
      entriesCountEl.textContent = entries.length;
      
      // Show/hide empty state message
      if (entries.length === 0) {
        noEntriesMessageEl.classList.remove('hidden');
        journalEntriesContainerEl.classList.add('hidden');
      } else {
        noEntriesMessageEl.classList.add('hidden');
        journalEntriesContainerEl.classList.remove('hidden');
        
        // Clear existing entries
        journalEntriesContainerEl.innerHTML = '';
        
        // Sort entries by timestamp (newest first)
        const sortedEntries = [...entries].sort((a, b) => b.timestamp - a.timestamp);
        
        // Create entry elements
        sortedEntries.forEach(entry => {
          const entryEl = document.createElement('div');
          entryEl.className = `journal-entry p-4 bg-gray-50 dark:bg-gray-700 rounded-lg ${entryTypes[entry.type].color}`;
          
          // Highlight search terms in note
          const highlightedNote = highlightSearchTerms(entry.note).replace(/\n/g, '<br>');
          
          // Create HTML for the entry
          let entryHTML = `
            <div class="flex flex-wrap justify-between items-start mb-2">
              <div class="flex items-center mr-4 mb-2">
                <span class="${entryTypes[entry.type].bgColor} p-1 rounded-md ${entryTypes[entry.type].color} mr-2">
                  <i class="fas ${entryTypes[entry.type].icon}"></i>
                </span>
                <span class="font-medium text-sm">${entryTypes[entry.type].label}</span>
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">
                ${entry.time}
                ${entry.phase ? `| ${entry.phase}` : ''}
              </div>
            </div>
            <div class="text-gray-700 dark:text-gray-300 text-sm whitespace-pre-wrap mb-2">
              ${highlightedNote}
            </div>
          `;
          
          // Add tags if present
          if (entry.tags && entry.tags.length > 0) {
            entryHTML += `
              <div class="flex flex-wrap gap-1 mt-2 mb-2">
                ${entry.tags.map(tag => `
                  <span class="tag px-2 py-0.5 bg-primary/10 dark:bg-primary-dark/20 text-primary dark:text-primary-light rounded text-xs">
                    #${tag}
                  </span>
                `).join('')}
              </div>
            `;
          }
          
          // Add images if present (using the new format)
          if (entry.imageFiles && entry.imageFiles.length > 0) {
            entryHTML += `<div class="journal-images-grid">`;
            
            entry.imageFiles.forEach((imageData, index) => {
              entryHTML += `
                <div class="journal-image-container">
                  <img src="${imageData}" alt="Journal entry image ${index + 1}" class="journal-image">
                  <button class="image-zoom-btn" data-entry-id="${entry.id}" data-image-index="${index}">
                    <i class="fas fa-search-plus"></i>
                  </button>
                </div>
              `;
            });
            
            entryHTML += `</div>`;
          }
          // For backward compatibility with the old format
          else if (entry.imageData) {
            entryHTML += `
              <div class="journal-image-container mt-3">
                <img src="${entry.imageData}" alt="Journal entry image" class="journal-image">
                <button class="image-zoom-btn" data-entry-id="${entry.id}" data-image-index="0">
                  <i class="fas fa-search-plus"></i>
                </button>
              </div>
            `;
          }
          
          // Add actions buttons (edit/delete)
          entryHTML += `
            <div class="flex justify-end mt-2 space-x-2 entry-actions">
              <button class="text-xs text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary-light edit-entry-btn px-2 py-1 rounded hover:bg-primary/10" data-entry-id="${entry.id}">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="text-xs text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400 delete-entry-btn px-2 py-1 rounded hover:bg-red-500/10" data-entry-id="${entry.id}">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          `;
          
          entryEl.innerHTML = entryHTML;
          journalEntriesContainerEl.appendChild(entryEl);
        });
        
        // Add event listeners for edit buttons
        document.querySelectorAll('.edit-entry-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            editJournalEntry(btn.dataset.entryId);
          });
        });
        
        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-entry-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            currentEntryToDelete = btn.dataset.entryId;
            deleteModalEl.classList.remove('hidden');
          });
        });
        
        // Add event listeners for image zoom buttons
        document.querySelectorAll('.image-zoom-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const entryId = btn.dataset.entryId;
            const imageIndex = parseInt(btn.dataset.imageIndex, 10);
            openImageFullscreen(entryId, imageIndex);
          });
        });
      }
    }
    
    // Open image in fullscreen view
    function openImageFullscreen(entryId, imageIndex) {
      const dateStr = formatDateISO(currentJournalDate);
      if (!journalData[dateStr]) return;
      
      const entry = journalData[dateStr].find(e => e.id === entryId);
      if (!entry) return;
      
      // Get the images from the entry (handle both old and new format)
      const images = entry.imageFiles || (entry.imageData ? [entry.imageData] : []);
      if (images.length === 0) return;
      
      // Set the main image
      fullscreenImageEl.src = images[imageIndex];
      
      // Create thumbnails if there are multiple images
      fullscreenThumbnailsEl.innerHTML = '';
      if (images.length > 1) {
        images.forEach((img, idx) => {
          const thumbnail = document.createElement('img');
          thumbnail.src = img;
          thumbnail.alt = `Thumbnail ${idx + 1}`;
          thumbnail.className = `fullscreen-thumbnail ${idx === imageIndex ? 'active' : ''}`;
          thumbnail.dataset.index = idx;
          
          thumbnail.addEventListener('click', () => {
            fullscreenImageEl.src = img;
            document.querySelectorAll('.fullscreen-thumbnail').forEach(thumb => {
              thumb.classList.toggle('active', parseInt(thumb.dataset.index, 10) === idx);
            });
          });
          
          fullscreenThumbnailsEl.appendChild(thumbnail);
        });
      }
      
      // Show the fullscreen modal
      imageFullscreenModalEl.classList.remove('hidden');
    }
    
    // Convert image to base64
    function getBase64Image(file) {
      return new Promise((resolve, reject) => {
        if (!file) {
          resolve(null);
          return;
        }
        
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }
    
    // Add image previews
    async function addImagePreviews(files) {
      if (!files || files.length === 0) return;
      
      try {
        // Clear existing previews if in a new entry (not editing)
        if (!isEditMode) {
          imagePreviewsContainerEl.innerHTML = '';
          currentImageFiles = [];
        }
        
        // Process each file
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
          // Check if file is an image
          if (!file.type.startsWith('image/')) {
            showNotification('One of the selected files is not an image. Please choose image files only.', false);
            continue;
          }
          
          // Check file size (5MB max)
          if (file.size > 5 * 1024 * 1024) {
            showNotification(`Image "${file.name}" is too large (max 5MB).`, false);
            continue;
          }
          
          // Convert to base64
          const imageData = await getBase64Image(file);
          
          // Add to current images array
          currentImageFiles.push(imageData);
          
          // Create preview item
          const previewItem = document.createElement('div');
          previewItem.className = 'image-preview-item';
          
          const index = currentImageFiles.length - 1;
          previewItem.innerHTML = `
            <img src="${imageData}" alt="Image preview ${index + 1}">
            <button class="remove-preview-btn" data-index="${index}">
              <i class="fas fa-times"></i>
            </button>
          `;
          
          imagePreviewsContainerEl.appendChild(previewItem);
          
          // Add event listener to remove button
          previewItem.querySelector('.remove-preview-btn').addEventListener('click', (e) => {
            const idx = parseInt(e.currentTarget.dataset.index, 10);
            removeImagePreview(idx);
          });
        }
        
        // Show the previews container
        imagePreviewsContainerEl.classList.remove('hidden');
        
        // Update file name display
        imageFileNameEl.textContent = `${currentImageFiles.length} images selected`;
      } catch (error) {
        console.error('Error processing image files:', error);
        showNotification('Error processing images. Please try again.', false);
      }
    }
    
    // Remove image preview at specific index
    function removeImagePreview(index) {
      if (index < 0 || index >= currentImageFiles.length) return;
      
      // Remove from array
      currentImageFiles.splice(index, 1);
      
      // Rebuild previews to update indexes
      imagePreviewsContainerEl.innerHTML = '';
      
      currentImageFiles.forEach((imageData, idx) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'image-preview-item';
        previewItem.innerHTML = `
          <img src="${imageData}" alt="Image preview ${idx + 1}">
          <button class="remove-preview-btn" data-index="${idx}">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        imagePreviewsContainerEl.appendChild(previewItem);
        
        // Add event listener to remove button
        previewItem.querySelector('.remove-preview-btn').addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.dataset.index, 10);
          removeImagePreview(index);
        });
      });
      
      // Update file name display or hide container if empty
      if (currentImageFiles.length === 0) {
        imagePreviewsContainerEl.classList.add('hidden');
        imageFileNameEl.textContent = 'No files chosen';
      } else {
        imageFileNameEl.textContent = `${currentImageFiles.length} images selected`;
      }
    }
    
    // Add tag to current journal entry
    function addTag(tagName) {
      if (!tagName) return;
      
      // Clean tag name
      tagName = tagName.trim().toLowerCase().replace(/[^\w-]/g, '');
      
      if (!tagName) return;
      
      // Check if tag already exists
      if (currentJournalTags.includes(tagName)) return;
      
      // Add tag to array
      currentJournalTags.push(tagName);
      
      // Add tag to UI
      const tagEl = document.createElement('div');
      tagEl.className = 'tag px-2 py-1 bg-primary/10 dark:bg-primary-dark/20 text-primary dark:text-primary-light rounded text-xs flex items-center';
      tagEl.innerHTML = `
        #${tagName}
        <button class="remove-tag-btn ml-1 text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400" data-tag="${tagName}">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      journalTagsContainerEl.appendChild(tagEl);
      
      // Add event listener to remove button
      tagEl.querySelector('.remove-tag-btn').addEventListener('click', (e) => {
        const tagToRemove = e.currentTarget.dataset.tag;
        removeTag(tagToRemove);
      });
      
      // Clear input
      journalTagInputEl.value = '';
    }
    
    // Remove tag from current journal entry
    function removeTag(tagName) {
      // Remove tag from array
      const tagIndex = currentJournalTags.indexOf(tagName);
      if (tagIndex > -1) {
        currentJournalTags.splice(tagIndex, 1);
      }
      
      // Remove tag from UI
      const tagElements = journalTagsContainerEl.querySelectorAll('.tag');
      tagElements.forEach(el => {
        if (el.textContent.includes(`#${tagName}`)) {
          el.remove();
        }
      });
    }
    
    // Handle adding filter tag
    function addFilterTag(tagName) {
      if (!tagName) return;
      
      // Clean tag name
      tagName = tagName.trim().toLowerCase().replace(/[^\w-]/g, '');
      
      if (!tagName) return;
      
      // Check if tag already exists
      if (currentFilterTags.includes(tagName)) return;
      
      // Add tag to array
      currentFilterTags.push(tagName);
      
      // Add tag to UI
      const tagEl = document.createElement('div');
      tagEl.className = 'tag px-2 py-1 bg-primary/10 dark:bg-primary-dark/20 text-primary dark:text-primary-light rounded text-xs flex items-center';
      tagEl.innerHTML = `
        #${tagName}
        <button class="remove-filter-tag-btn ml-1 text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400" data-tag="${tagName}">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      tagFilterContainerEl.appendChild(tagEl);
      
      // Add event listener to remove button
      tagEl.querySelector('.remove-filter-tag-btn').addEventListener('click', (e) => {
        const tagToRemove = e.currentTarget.dataset.tag;
        removeFilterTag(tagToRemove);
      });
      
      // Clear input
      tagFilterInputEl.value = '';
    }
    
    // Remove tag from filter
    function removeFilterTag(tagName) {
      // Remove tag from array
      const tagIndex = currentFilterTags.indexOf(tagName);
      if (tagIndex > -1) {
        currentFilterTags.splice(tagIndex, 1);
      }
      
      // Remove tag from UI
      const tagElements = tagFilterContainerEl.querySelectorAll('.tag');
      tagElements.forEach(el => {
        if (el.textContent.includes(`#${tagName}`)) {
          el.remove();
        }
      });
    }
    
    // Save a new journal entry or update an existing one
    async function saveJournalEntry() {
      const dateStr = journalDateEl.value;
      const note = journalNoteEl.value.trim();
      const type = journalEntryTypeEl.value;
      const entryId = journalEntryIdEl.value;
      
      if (!note) {
        showNotification('Please enter a note before saving.', false);
        return;
      }
      
      if (!dateStr) {
        showNotification('Please select a date for your entry.', false);
        return;
      }
      
      // Get current phase info
      const easternTime = getEasternTime();
      const currentPhase = getCurrentPhase(easternTime);
      const currentSubphase = getCurrentSubphase(easternTime, currentPhase);
      
      try {
        // Process images (already processed in image previews)
        const imageFiles = currentImageFiles;
        
        // Combine manual tags with auto-generated tags
        let entryTags = [...currentJournalTags];
        
        // Add auto-generated tags if enabled
        if (userSettings.journal.autoTag) {
          const autoTags = autoGenerateTags(note);
          // Merge tags without duplicates
          autoTags.forEach(tag => {
            if (!entryTags.includes(tag)) {
              entryTags.push(tag);
            }
          });
        }
        
        // Create entry object
        const entry = {
          id: isEditMode ? entryId : generateEntryId(),
          date: dateStr,
          time: formatTime(easternTime),
          timestamp: isEditMode ? (journalData[dateStr].find(e => e.id === entryId)?.timestamp || Date.now()) : Date.now(),
          type: type,
          note: note,
          phase: `${currentPhase.emoji} ${currentPhase.name}`,
          subphase: currentSubphase ? currentSubphase.name : null,
          imageFiles: imageFiles,
          tags: entryTags
        };
        
        // Add or update entry in journal data
        if (!journalData[dateStr]) {
          journalData[dateStr] = [];
        }
        
        if (isEditMode) {
          // Update existing entry
          const entryIndex = journalData[dateStr].findIndex(e => e.id === entryId);
          if (entryIndex !== -1) {
            journalData[dateStr][entryIndex] = entry;
          } else {
            // If somehow the entry is not found, add it as new
            journalData[dateStr].push(entry);
          }
        } else {
          // Add new entry
          journalData[dateStr].push(entry);
        }
        
        // Save to localStorage
        saveJournalData();
        
        // Reset form
        if (isEditMode) {
          cancelEdit(); // Exit edit mode
        } else {
          // Just clear the form
          journalNoteEl.value = '';
          imageUploadEl.value = '';
          imageFileNameEl.textContent = 'No files chosen';
          imagePreviewsContainerEl.innerHTML = '';
          imagePreviewsContainerEl.classList.add('hidden');
          currentImageFiles = [];
          currentJournalTags = [];
          journalTagsContainerEl.innerHTML = '';
        }
        
        // Update UI
        showNotification(isEditMode ? 'Journal entry updated!' : 'Journal entry saved!', false);
        selectJournalDate(new Date(dateStr)); // Refresh the entries display
        updateCalendar(); // Update calendar to show days with entries
      } catch (error) {
        console.error('Error saving journal entry:', error);
        showNotification('Error saving entry. Please try again.', false);
      }
    }
    
    // Delete a journal entry
    function deleteJournalEntry(entryId) {
      const dateStr = formatDateISO(currentJournalDate);
      
      if (journalData[dateStr]) {
        const entryIndex = journalData[dateStr].findIndex(entry => entry.id === entryId);
        
        if (entryIndex !== -1) {
          journalData[dateStr].splice(entryIndex, 1);
          
          // If no entries left for this date, remove the date key
          if (journalData[dateStr].length === 0) {
            delete journalData[dateStr];
          }
          
          // Save to localStorage
          saveJournalData();
          
          // Update UI
          showNotification('Journal entry deleted', false);
          displayJournalEntries(); // Refresh the entries display
          updateCalendar(); // Update calendar to show days with entries
        }
      }
    }
    
    // Insert timestamp into note
    function insertTimestamp() {
      const now = new Date();
      const timestampText = `[${formatTimeWithSeconds(now)}] `;
      
      // Get current cursor position
      const cursorPos = journalNoteEl.selectionStart;
      
      // Insert timestamp at cursor position
      const textBefore = journalNoteEl.value.substring(0, cursorPos);
      const textAfter = journalNoteEl.value.substring(cursorPos);
      journalNoteEl.value = textBefore + timestampText + textAfter;
      
      // Reset cursor position after the inserted timestamp
      journalNoteEl.selectionStart = cursorPos + timestampText.length;
      journalNoteEl.selectionEnd = cursorPos + timestampText.length;
      
      // Focus back on the textarea
      journalNoteEl.focus();
    }
    
    // Export journal data
    function exportJournalDataToJSON() {
      const exportData = JSON.stringify(journalData, null, 2);
      exportDataEl.value = exportData;
      exportModalEl.classList.remove('hidden');
    }
    
    // Copy export data to clipboard
    function copyExportDataToClipboard() {
      exportDataEl.select();
      
      try {
        document.execCommand('copy');
        showNotification('Journal data copied to clipboard!', false);
      } catch (err) {
        showNotification('Failed to copy data. Please try manually selecting and copying.', false);
      }
    }
    
    // Download export data as file
    function downloadExportData() {
      const exportData = JSON.stringify(journalData, null, 2);
      const blob = new Blob([exportData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const today = new Date();
      const dateStr = formatDateISO(today);
      const fileName = `nasdaq-journal-${dateStr}.json`;
      
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.target = '_blank';
      a.style.display = 'none';
      
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      
      showNotification('Journal data downloaded!', false);
    }
    
    // Export journal data as CSV
    function exportJournalDataToCSV() {
      // Prepare CSV header
      const csvHeader = "Date,Time,Type,Phase,Note,Tags\n";
      
      // Prepare CSV content
      let csvContent = csvHeader;
      
      // Process each entry
      Object.keys(journalData).sort().forEach(date => {
        journalData[date].forEach(entry => {
          // Clean note text for CSV (escape quotes, remove line breaks)
          const cleanNote = entry.note.replace(/"/g, '""').replace(/\n/g, ' ');
          
          // Format tags as comma-separated list
          const tagsList = entry.tags ? entry.tags.join(', ') : '';
          
          // Create CSV row
          const row = [
            date,
            entry.time,
            entryTypes[entry.type].label,
            (entry.phase || '').replace(/[\u{1F300}-\u{1F6FF}]/gu, '').trim(), // Remove emoji
            `"${cleanNote}"`,
            tagsList
          ].join(',');
          
          csvContent += row + '\n';
        });
      });
      
      // Create and download CSV file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      
      const today = new Date();
      const dateStr = formatDateISO(today);
      const fileName = `nasdaq-journal-${dateStr}.csv`;
      
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.target = '_blank';
      a.style.display = 'none';
      
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      
      showNotification('Journal data exported as CSV!', false);
    }
    
    // Import journal data
    function importJournalData() {
      try {
        let importedData = {};
        
        // Try to parse the input JSON
        if (importDataEl.value.trim()) {
          importedData = JSON.parse(importDataEl.value);
        }
        
        // Check if this is valid journal data
        if (typeof importedData !== 'object') {
          throw new Error('Invalid journal data format');
        }
        
        // Determine import mode
        const importMode = document.querySelector('input[name="import-mode"]:checked').value;
        
        if (importMode === 'replace') {
          // Replace all data
          journalData = importedData;
        } else {
          // Merge with existing data
          Object.keys(importedData).forEach(date => {
            if (!journalData[date]) {
              journalData[date] = [];
            }
            
            // Add each entry, ensuring it has a unique ID
            importedData[date].forEach(importedEntry => {
              // Check if entry already exists by comparing timestamps
              const entryExists = journalData[date].some(existingEntry => 
                existingEntry.timestamp === importedEntry.timestamp
              );
              
              if (!entryExists) {
                // Ensure the entry has a valid ID
                if (!importedEntry.id) {
                  importedEntry.id = generateEntryId();
                }
                
                // Ensure the entry has a tags array
                if (!importedEntry.tags) {
                  importedEntry.tags = [];
                }
                
                // Convert older entries with single imageData to array format
                if (importedEntry.imageData && !importedEntry.imageFiles) {
                  importedEntry.imageFiles = [importedEntry.imageData];
                  importedEntry.imageData = undefined; // Clear old format
                }
                
                journalData[date].push(importedEntry);
              }
            });
          });
        }
        
        // Save to localStorage
        saveJournalData();
        
        // Update UI
        showNotification('Journal data imported successfully!', false);
        importModalEl.classList.add('hidden');
        importDataEl.value = '';
        
        // Refresh the journal display
        selectJournalDate(currentJournalDate);
        
        // Refresh analytics if visible
        if (!analyticsTabContentEl.classList.contains('hidden')) {
          updateAnalytics();
        }
      } catch (error) {
        console.error('Error importing journal data:', error);
        showNotification('Error importing data. Please check the format and try again.', false);
      }
    }
    
    // Process imported file
    function processImportFile() {
      const file = importFileEl.files[0];
      if (!file) return;
      
      // Update file name display
      importFileNameEl.textContent = file.name;
      
      // Check if file is JSON
      if (!file.name.endsWith('.json')) {
        showNotification('Please select a JSON file.', false);
        return;
      }
      
      // Read file content
      const reader = new FileReader();
      reader.onload = function(e) {
        importDataEl.value = e.target.result;
      };
      reader.readAsText(file);
    }
    
    // Clear all journal data
    function clearAllJournalData() {
      journalData = {};
      saveJournalData();
      
      // Update UI
      showNotification('All journal entries have been cleared', false);
      selectJournalDate(currentJournalDate); // Refresh the entries display
      updateCalendar(); // Update calendar
      clearJournalModalEl.classList.add('hidden');
      
      // Refresh analytics if visible
      if (!analyticsTabContentEl.classList.contains('hidden')) {
        updateAnalytics();
      }
    }
    
    // Update journal UI (entry form)
    function updateJournalUI() {
      // Cancel any ongoing edit
      if (isEditMode) {
        cancelEdit();
      }
      
      // Set date input to today's date by default
      const today = new Date();
      journalDateEl.value = formatDateISO(today);
      currentJournalDateEl.textContent = formatDateDisplay(today);
      
      // Update phase and time
      const easternTime = getEasternTime();
      const currentPhase = getCurrentPhase(easternTime);
      const currentSubphase = getCurrentSubphase(easternTime, currentPhase);
      
      journalTimeEl.textContent = formatTime(easternTime);
      journalSystemTimeEl.textContent = formatTimeWithSeconds(new Date());
      const phaseInfo = `${currentPhase.emoji} ${currentPhase.name}`;
      const subphaseInfo = currentSubphase ? ` | ${currentSubphase.name}` : '';
      journalPhaseEl.textContent = phaseInfo + subphaseInfo;
      
      // Reset active entry type and entry type field
      entryTypeBtns.forEach(btn => btn.classList.remove('bg-primary', 'text-white', 'border-primary', 'dark:bg-primary-dark', 'dark:border-primary-dark'));
      const observationBtn = document.querySelector('[data-type="observation"]');
      observationBtn.classList.add('bg-primary', 'text-white', 'border-primary', 'dark:bg-primary-dark', 'dark:border-primary-dark');
      journalEntryTypeEl.value = 'observation';
      
      // Reset journal tags
      currentJournalTags = [];
      journalTagsContainerEl.innerHTML = '';
      
      // Reset image uploads
      imageUploadEl.value = '';
      imageFileNameEl.textContent = 'No files chosen';
      imagePreviewsContainerEl.innerHTML = '';
      imagePreviewsContainerEl.classList.add('hidden');
      currentImageFiles = [];
      
      // Update calendar and entries display
      displayedMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      currentJournalDate = today;
      updateCalendar();
      displayJournalEntries();
      
      // Update available tags for filters
      updateAvailableTags();
    }
    
    // Update available tags for filtering
    function updateAvailableTags() {
      // Collect all unique tags from all entries
      const allTags = new Set();
      
      Object.values(journalData).forEach(entries => {
        entries.forEach(entry => {
          if (entry.tags && Array.isArray(entry.tags)) {
            entry.tags.forEach(tag => allTags.add(tag));
          }
        });
      });
      
      // Update tag filter input with datalist
      const datalistId = 'tag-suggestions';
      let datalist = document.getElementById(datalistId);
      
      if (!datalist) {
        datalist = document.createElement('datalist');
        datalist.id = datalistId;
        document.body.appendChild(datalist);
        tagFilterInputEl.setAttribute('list', datalistId);
      }
      
      // Clear existing options
      datalist.innerHTML = '';
      
      // Add options
      Array.from(allTags).sort().forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        datalist.appendChild(option);
      });
    }
    
    // Navigate to previous day
    function navigateToPreviousDay() {
      const prevDay = new Date(currentJournalDate);
      prevDay.setDate(prevDay.getDate() - 1);
      selectJournalDate(prevDay);
    }
    
    // Navigate to next day
    function navigateToNextDay() {
      const nextDay = new Date(currentJournalDate);
      nextDay.setDate(nextDay.getDate() + 1);
      selectJournalDate(nextDay);
    }
    
    // Navigate to today
    function navigateToToday() {
      selectJournalDate(new Date());
    }
    
    // Navigate to previous month
    function navigateToPreviousMonth() {
      displayedMonth.setMonth(displayedMonth.getMonth() - 1);
      updateCalendar();
    }
    
    // Navigate to next month
    function navigateToNextMonth() {
      displayedMonth.setMonth(displayedMonth.getMonth() + 1);
      updateCalendar();
    }
    
    // Analytics functions
    
    // Update analytics date range
    function updateAnalyticsDateRange(range) {
      const today = new Date();
      let startDate, endDate;
      
      switch (range) {
        case 'week':
          // Last 7 days
          startDate = new Date(today);
          startDate.setDate(today.getDate() - 7);
          endDate = today;
          break;
        
        case 'month':
          // Current month
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = today;
          break;
        
        case 'quarter':
          // Last 3 months
          startDate = new Date(today);
          startDate.setMonth(today.getMonth() - 3);
          endDate = today;
          break;
        
        case 'custom':
          // Use the custom date inputs
          startDate = new Date(analyticsStartDateEl.value);
          endDate = new Date(analyticsEndDateEl.value);
          break;
        
        default: // 'all'
          // All time
          startDate = new Date(2020, 0, 1); // Arbitrary start date in the past
          endDate = today;
          break;
      }
      
      // Update the date inputs
      analyticsStartDateEl.value = formatDateISO(startDate);
      analyticsEndDateEl.value = formatDateISO(endDate);
      
      // Save the date range
      analyticsDateRange = { start: startDate, end: endDate };
      
      // Update active button style
      presetBtns.forEach(btn => {
        if (btn.dataset.range === range) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }
    
    // Get entries within the selected date range
    function getEntriesInDateRange() {
      const entries = [];
      const { start, end } = analyticsDateRange;
      
      // Convert dates to ISO strings for comparison
      const startISO = formatDateISO(start);
      const endISO = formatDateISO(end);
      
      // Collect entries from all dates within range
      Object.keys(journalData).forEach(dateStr => {
        if (dateStr >= startISO && dateStr <= endISO) {
          entries.push(...journalData[dateStr]);
        }
      });
      
      return entries;
    }
    
    // Calculate entry statistics
    function calculateEntryStats(entries) {
      // Previous period for comparison (same length as current period)
      const currentPeriodDays = Math.ceil((analyticsDateRange.end - analyticsDateRange.start) / (1000 * 60 * 60 * 24));
      const previousPeriodStart = new Date(analyticsDateRange.start);
      previousPeriodStart.setDate(previousPeriodStart.getDate() - currentPeriodDays);
      const previousPeriodEnd = new Date(analyticsDateRange.start);
      previousPeriodEnd.setDate(previousPeriodEnd.getDate() - 1);
      
      // Get entries from previous period
      const prevStartISO = formatDateISO(previousPeriodStart);
      const prevEndISO = formatDateISO(previousPeriodEnd);
      const previousEntries = [];
      
      Object.keys(journalData).forEach(dateStr => {
        if (dateStr >= prevStartISO && dateStr <= prevEndISO) {
          previousEntries.push(...journalData[dateStr]);
        }
      });
      
      // Count entry types
      const typeCounts = {
        observation: 0,
        trade: 0,
        strategy: 0,
        note: 0
      };
      
      entries.forEach(entry => {
        if (typeCounts[entry.type] !== undefined) {
          typeCounts[entry.type]++;
        }
      });
      
      // Find most common entry type
      let topEntryType = 'observation';
      let topEntryCount = 0;
      
      Object.entries(typeCounts).forEach(([type, count]) => {
        if (count > topEntryCount) {
          topEntryType = type;
          topEntryCount = count;
        }
      });
      
      // Count phases
      const phaseCounts = {};
      
      entries.forEach(entry => {
        if (entry.phase) {
          // Extract phase ID from phase name
          const phaseId = marketPhases.find(p => entry.phase.includes(p.name))?.id || 'unknown';
          
          if (!phaseCounts[phaseId]) {
            phaseCounts[phaseId] = {
              id: phaseId,
              count: 0,
              name: entry.phase.replace(/[\u{1F300}-\u{1F6FF}]/gu, '').trim(), // Remove emoji
              emoji: entry.phase.match(/[\u{1F300}-\u{1F6FF}]/gu)?.[0] || ''
            };
          }
          
          phaseCounts[phaseId].count++;
        }
      });
      
      // Find most active phase
      let mostActivePhase = { id: 'unknown', count: 0, name: 'Unknown', emoji: '' };
      
      Object.values(phaseCounts).forEach(phase => {
        if (phase.count > mostActivePhase.count) {
          mostActivePhase = phase;
        }
      });
      
      // Count tags
      const tagCounts = {};
      
      entries.forEach(entry => {
        if (entry.tags && Array.isArray(entry.tags)) {
          entry.tags.forEach(tag => {
            if (!tagCounts[tag]) {
              tagCounts[tag] = 0;
            }
            tagCounts[tag]++;
          });
        }
      });
      
      // Find most used tags
      const sortedTags = Object.entries(tagCounts)
        .sort((a, b) => b[1] - a[1])
        .map(([tag, count]) => ({ tag, count }));
      
      // Calculate trend percentage from previous period
      let trendPercentage = 0;
      if (previousEntries.length > 0) {
        const change = entries.length - previousEntries.length;
        trendPercentage = Math.round((change / previousEntries.length) * 100);
      } else if (entries.length > 0) {
        trendPercentage = 100; // If there were no previous entries, it's a 100% increase
      }
      
      // Prepare entry dates for activity chart
      const entryDates = {};
      
      // Initialize all dates in range with 0 count
      const daysBetween = Math.ceil((analyticsDateRange.end - analyticsDateRange.start) / (1000 * 60 * 60 * 24));
      for (let i = 0; i <= daysBetween; i++) {
        const date = new Date(analyticsDateRange.start);
        date.setDate(date.getDate() + i);
        entryDates[formatDateISO(date)] = 0;
      }
      
      // Count entries per date
      entries.forEach(entry => {
        if (entry.date) {
          if (!entryDates[entry.date]) {
            entryDates[entry.date] = 0;
          }
          entryDates[entry.date]++;
        }
      });
      
      return {
        totalEntries: entries.length,
        trendPercentage,
        typeCounts,
        topEntryType: {
          id: topEntryType,
          count: topEntryCount,
          percentage: entries.length > 0 ? Math.round((topEntryCount / entries.length) * 100) : 0
        },
        phaseCounts: Object.values(phaseCounts),
        mostActivePhase: {
          ...mostActivePhase,
          percentage: entries.length > 0 ? Math.round((mostActivePhase.count / entries.length) * 100) : 0
        },
        entryDates,
        topTags: sortedTags.slice(0, 10)
      };
    }
    
    // Update analytics UI
    function updateAnalytics() {
      // Get entries within date range
      const entries = getEntriesInDateRange();
      
      // Calculate statistics
      const stats = calculateEntryStats(entries);
      
      // Update summary cards
      totalEntriesEl.textContent = stats.totalEntries;
      entriesTrendEl.textContent = `${stats.trendPercentage >= 0 ? '+' : ''}${stats.trendPercentage}%`;
      
      mostActivePhaseEl.textContent = stats.mostActivePhase.name;
      mostActivePhaseCountEl.textContent = `${stats.mostActivePhase.count} entries`;
      mostActivePhaseIconEl.textContent = stats.mostActivePhase.emoji || '📊';
      activePhasePercentageEl.textContent = `${stats.mostActivePhase.percentage}%`;
      
      topEntryTypeEl.textContent = entryTypes[stats.topEntryType.id].label;
      topEntryTypeCountEl.textContent = `${stats.topEntryType.count} entries`;
      topEntryTypeIconEl.innerHTML = `<i class="fas ${entryTypes[stats.topEntryType.id].icon}"></i>`;
      entryTypePercentageEl.textContent = `${stats.topEntryType.percentage}%`;
      
      if (stats.topTags.length > 0) {
        topTagEl.textContent = `#${stats.topTags[0].tag}`;
        topTagCountEl.textContent = `${stats.topTags[0].count} occurrences`;
        
        // Show popular tags
        popularTagsEl.innerHTML = stats.topTags.slice(0, 5).map(tag => 
          `<span class="tag px-2 py-0.5 bg-primary/10 dark:bg-primary-dark/20 text-primary dark:text-primary-light rounded text-xs">#${tag.tag}</span>`
        ).join(' ');
      } else {
        topTagEl.textContent = '-';
        topTagCountEl.textContent = '0 occurrences';
        popularTagsEl.textContent = 'No tags yet';
      }
      
      // Update charts
      updatePhaseDistributionChart(stats.phaseCounts);
      updateActivityChart(stats.entryDates);
      updateEntryTypesChart(stats.typeCounts);
      updateTagCloud(stats.topTags);
      
      // Update recent entries table
      updateRecentEntriesTable(entries);
    }
    
    // Update phase distribution chart
    function updatePhaseDistributionChart(phaseCounts) {
      // Sort phases by market cycle order
      phaseCounts.sort((a, b) => {
        const phaseOrder = marketPhases.map(p => p.id);
        return phaseOrder.indexOf(a.id) - phaseOrder.indexOf(b.id);
      });
      
      const labels = phaseCounts.map(p => p.name);
      const data = phaseCounts.map(p => p.count);
      const backgroundColors = phaseCounts.map(p => {
        const phaseIndex = marketPhases.findIndex(mp => mp.id === p.id);
        const hue = (phaseIndex * 45) % 360; // Spread colors around the color wheel
        return `hsla(${hue}, 70%, 60%, 0.7)`;
      });
      
      const ctx = phaseDistributionChartEl.getContext('2d');
      
      if (phaseDistributionChart) {
        phaseDistributionChart.destroy();
      }
      
      phaseDistributionChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151',
                padding: 10,
                usePointStyle: true,
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} entries (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    // Update activity chart
    function updateActivityChart(entryDates) {
      const sortedDates = Object.keys(entryDates).sort();
      const data = sortedDates.map(date => entryDates[date]);
      
      // Format dates for display
      const displayDates = sortedDates.map(date => {
        const dateObj = new Date(date);
        return dateObj.getDate() + '/' + (dateObj.getMonth() + 1);
      });
      
      const ctx = activityChartEl.getContext('2d');
      
      if (activityChart) {
        activityChart.destroy();
      }
      
      activityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: displayDates,
          datasets: [{
            label: 'Journal Entries',
            data: data,
            backgroundColor: 'rgba(93, 92, 222, 0.2)',
            borderColor: 'rgba(93, 92, 222, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(93, 92, 222, 1)',
            pointRadius: 3,
            pointHoverRadius: 5,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
              },
              grid: {
                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              ticks: {
                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151',
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(tooltipItems) {
                  const dateStr = sortedDates[tooltipItems[0].dataIndex];
                  return formatDateDisplay(new Date(dateStr));
                }
              }
            }
          }
        }
      });
    }
    
    // Update entry types chart
    function updateEntryTypesChart(typeCounts) {
      const labels = Object.keys(typeCounts).map(type => entryTypes[type].label);
      const data = Object.values(typeCounts);
      const backgroundColors = Object.keys(typeCounts).map(type => {
        switch(type) {
          case 'observation': return 'rgba(33, 150, 243, 0.7)';
          case 'trade': return 'rgba(76, 175, 80, 0.7)';
          case 'strategy': return 'rgba(156, 39, 176, 0.7)';
          case 'note': return 'rgba(255, 193, 7, 0.7)';
          default: return 'rgba(96, 125, 139, 0.7)';
        }
      });
      
      const ctx = entryTypesChartEl.getContext('2d');
      
      if (entryTypesChart) {
        entryTypesChart.destroy();
      }
      
      entryTypesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Number of Entries',
            data: data,
            backgroundColor: backgroundColors,
            borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
              },
              grid: {
                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              ticks: {
                color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151'
              },
              grid: {
                color: document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }
    
    // Update tag cloud
    function updateTagCloud(tags) {
      // Clear existing tags
      tagCloudEl.innerHTML = '';
      
      if (tags.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'text-gray-500 dark:text-gray-400 text-center';
        emptyMessage.textContent = 'No tags found in this date range';
        tagCloudEl.appendChild(emptyMessage);
        return;
      }
      
      // Find min and max counts for scaling
      const minCount = Math.min(...tags.map(t => t.count));
      const maxCount = Math.max(...tags.map(t => t.count));
      
      // Generate tag elements with scaled sizes
      tags.forEach(({ tag, count }) => {
        // Scale font size between 12px and 28px based on count
        const scaleFactor = maxCount > minCount 
          ? (count - minCount) / (maxCount - minCount)
          : 0.5;
        const fontSize = 12 + (scaleFactor * 16);
        
        // Scale opacity between 0.7 and 1 based on count
        const opacity = 0.7 + (scaleFactor * 0.3);
        
        const tagEl = document.createElement('div');
        tagEl.className = 'tag px-3 py-1.5 bg-primary/10 dark:bg-primary-dark/20 text-primary dark:text-primary-light rounded';
        tagEl.style.fontSize = `${fontSize}px`;
        tagEl.style.opacity = opacity;
        tagEl.textContent = `#${tag}`;
        
        tagCloudEl.appendChild(tagEl);
      });
    }
    
    // Update recent entries table
    function updateRecentEntriesTable(entries) {
      // Clear existing entries
      recentEntriesTableEl.innerHTML = '';
      
      if (entries.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
          <td colspan="6" class="px-3 py-4 text-center text-gray-500 dark:text-gray-400">
            No entries found in this date range
          </td>
        `;
        recentEntriesTableEl.appendChild(emptyRow);
        return;
      }
      
      // Sort entries by date (newest first)
      const sortedEntries = [...entries].sort((a, b) => b.timestamp - a.timestamp);
      
      // Show up to 10 most recent entries
      sortedEntries.slice(0, 10).forEach(entry => {
        const row = document.createElement('tr');
        row.className = 'border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700';
        
        // Prepare note preview (truncate if too long)
        const notePreview = entry.note.length > 50 
          ? entry.note.substring(0, 50) + '...' 
          : entry.note;
        
        row.innerHTML = `
          <td class="px-3 py-2">${entry.date}</td>
          <td class="px-3 py-2">${entry.time}</td>
          <td class="px-3 py-2">${entry.phase || '-'}</td>
          <td class="px-3 py-2">
            <span class="${entryTypes[entry.type].bgColor} px-2 py-0.5 rounded text-xs ${entryTypes[entry.type].color}">
              ${entryTypes[entry.type].label}
            </span>
          </td>
          <td class="px-3 py-2">${notePreview.replace(/\n/g, ' ')}</td>
          <td class="px-3 py-2">
            <button class="view-entry-btn px-2 py-1 text-xs rounded bg-primary text-white" data-date="${entry.date}" data-id="${entry.id}">
              View
            </button>
          </td>
        `;
        
        recentEntriesTableEl.appendChild(row);
      });
      
      // Add event listeners to view buttons
      document.querySelectorAll('.view-entry-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const date = btn.dataset.date;
          const id = btn.dataset.id;
          
          // Switch to journal tab
          switchTab('journal');
          
          // Navigate to entry date
          selectJournalDate(new Date(date));
          
          // Wait for entries to load, then highlight the entry
          setTimeout(() => {
            const entryEl = document.querySelector(`.journal-entry:has([data-entry-id="${id}"])`);
            if (entryEl) {
              entryEl.classList.add('entry-highlight');
              entryEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, 300);
        });
      });
    }

    // Update user settings
    function updateSettings() {
      userSettings.notifications.enabled = enableNotificationsToggle.checked;
      userSettings.notifications.phaseChange = phaseChangeAlertToggle.checked;
      userSettings.notifications.subphaseChange = subphaseChangeAlertToggle.checked;
      userSettings.notifications.soundAlerts = soundAlertsToggle.checked;
      userSettings.notifications.advancedWarning = advancedWarningToggle.checked;
      userSettings.display.showTimeline = showTimelineToggle.checked;
      userSettings.display.showBestWindows = showBestWindowsToggle.checked;
      userSettings.display.showAnalytics = showAnalyticsToggle.checked;
      userSettings.journal = {
        reminders: journalRemindersToggle.checked,
        autoTag: autoTagToggle.checked
      };
      
      // Apply settings
      try {
        localStorage.setItem('nasdaq-timing-settings', JSON.stringify(userSettings));
      } catch (e) {
        console.log('Could not save settings to localStorage:', e);
      }
      
      // Update UI based on settings
      const timelineSection = document.querySelector('section:nth-of-type(3)');
      const bestWindowsSection = document.querySelector('section:nth-of-type(4)');
      
      if (userSettings.display.showTimeline) {
        timelineSection.classList.remove('hidden');
      } else {
        timelineSection.classList.add('hidden');
      }
      
      if (userSettings.display.showBestWindows) {
        bestWindowsSection.classList.remove('hidden');
      } else {
        bestWindowsSection.classList.add('hidden');
      }
      
      // Show/hide analytics tab
      if (userSettings.display.showAnalytics) {
        analyticsTabBtn.classList.remove('hidden');
      } else {
        analyticsTabBtn.classList.add('hidden');
        
        // If analytics tab is currently selected, switch to overview
        if (!analyticsTabContentEl.classList.contains('hidden')) {
          switchTab('overview');
        }
      }
      
      // Update notification settings
      if (!userSettings.notifications.enabled) {
        document.getElementById('notification-text').textContent = 'Notifications off';
        document.getElementById('notification-icon').classList.remove('fa-bell');
        document.getElementById('notification-icon').classList.add('fa-bell-slash');
      } else {
        document.getElementById('notification-text').textContent = 'Notifications';
        document.getElementById('notification-icon').classList.remove('fa-bell-slash');
        document.getElementById('notification-icon').classList.add('fa-bell');
      }
    }

    // Update the clock and system time
    function updateClock() {
      const now = new Date();
      const easternTime = getEasternTime();
      
      // Update displayed times
      localTimeEl.textContent = formatTime(now);
      easternTimeEl.textContent = formatTime(easternTime);
      
      // Get current phase and update UI
      const currentPhase = getCurrentPhase(easternTime);
      updatePhaseInfo(currentPhase, easternTime);
      
      // Update journal time if journal tab is active
      if (!journalTabContentEl.classList.contains('hidden')) {
        journalTimeEl.textContent = formatTime(easternTime);
        journalSystemTimeEl.textContent = formatTimeWithSeconds(now);
      }
    }

    // Initialize the app
    function initialize() {
      // Update settings from saved values
      initSettingsForm();
      updateSettings();
      
      // Load journal data
      loadJournalData();
      
      // Generate timeline UI
      generateTimeline();
      
      // Generate schedule table
      generateScheduleTable();
      
      // Setup journal
      updateJournalUI();
      
      // Initialize analytics date range
      updateAnalyticsDateRange('all');
      
      // Initial update
      updateClock();
      
      // Update clock every second
      setInterval(updateClock, 1000);
      
      // Initialize audio context
      document.addEventListener('click', function initAudioOnFirstClick() {
        initAudioContext();
        document.removeEventListener('click', initAudioOnFirstClick);
      });
      
      // Event listeners - Main UI
      closeNotificationBtn.addEventListener('click', () => {
        notificationToastEl.classList.add('translate-y-20', 'opacity-0');
      });
      
      settingsBtn.addEventListener('click', () => {
        settingsModalEl.classList.remove('hidden');
      });
      
      closeSettingsBtn.addEventListener('click', () => {
        settingsModalEl.classList.add('hidden');
      });
      
      saveSettingsBtn.addEventListener('click', () => {
        updateSettings();
        settingsModalEl.classList.add('hidden');
        showNotification('Settings saved', false);
      });
      
      notificationToggleBtn.addEventListener('click', () => {
        userSettings.notifications.enabled = !userSettings.notifications.enabled;
        enableNotificationsToggle.checked = userSettings.notifications.enabled;
        updateSettings();
        showNotification(
          userSettings.notifications.enabled ? 'Notifications enabled' : 'Notifications disabled',
          false
        );
      });
      
      // Event listeners - Tab switching
      overviewTabBtn.addEventListener('click', () => switchTab('overview'));
      scheduleTabBtn.addEventListener('click', () => switchTab('schedule'));
      tradingTabBtn.addEventListener('click', () => switchTab('trading'));
      journalTabBtn.addEventListener('click', () => switchTab('journal'));
      analyticsTabBtn.addEventListener('click', () => switchTab('analytics'));
      
      // Event listeners - Journal
      saveJournalEntryBtn.addEventListener('click', saveJournalEntry);
      cancelEditBtn.addEventListener('click', cancelEdit);
      
      journalDateEl.addEventListener('change', () => {
        if (journalDateEl.value) {
          selectJournalDate(new Date(journalDateEl.value));
        }
      });
      
      entryTypeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          // Update active button styles
          entryTypeBtns.forEach(b => b.classList.remove('bg-primary', 'text-white', 'border-primary', 'dark:bg-primary-dark', 'dark:border-primary-dark'));
          btn.classList.add('bg-primary', 'text-white', 'border-primary', 'dark:bg-primary-dark', 'dark:border-primary-dark');
          
          // Update hidden input value
          journalEntryTypeEl.value = btn.dataset.type;
        });
      });
      
      // Event listeners - Filter and search
      filterTypeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          // Update active button styles
          filterTypeBtns.forEach(b => {
            b.classList.remove('bg-primary', 'text-white');
            b.classList.add('bg-gray-200', 'dark:bg-gray-700');
          });
          btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
          btn.classList.add('bg-primary', 'text-white');
          
          currentFilterType = btn.dataset.filter;
        });
      });
      
      journalSearchEl.addEventListener('input', (e) => {
        currentSearchText = e.target.value.trim();
      });
      
      searchBtnEl.addEventListener('click', () => {
        displayJournalEntries();
      });
      
      journalSearchEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          displayJournalEntries();
        }
      });
      
      filterBtnEl.addEventListener('click', () => {
        filterMenuEl.classList.toggle('hidden');
      });
      
      applyFiltersEl.addEventListener('click', () => {
        currentFilterPhase = phaseFilterEl.value;
        filterMenuEl.classList.add('hidden');
        displayJournalEntries();
      });
      
      clearFiltersEl.addEventListener('click', () => {
        resetFilters();
        displayJournalEntries();
      });
      
      tagFilterInputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && tagFilterInputEl.value.trim()) {
          addFilterTag(tagFilterInputEl.value);
        }
      });
      
      // Event listeners - Image upload
      imageUploadEl.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          // Process image previews
          addImagePreviews(e.target.files);
        }
      });
      
      // Image fullscreen modal
      closeFullscreenImageBtn.addEventListener('click', () => {
        imageFullscreenModalEl.classList.add('hidden');
      });
      
      // Event listener for timestamp insertion
      addTimestampBtn.addEventListener('click', insertTimestamp);
      
      // Event listeners - Tags
      journalTagInputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && journalTagInputEl.value.trim()) {
          addTag(journalTagInputEl.value);
        }
      });
      
      addTagBtnEl.addEventListener('click', () => {
        if (journalTagInputEl.value.trim()) {
          addTag(journalTagInputEl.value);
        }
      });
      
      // Event listeners - Journal navigation
      prevDayBtn.addEventListener('click', navigateToPreviousDay);
      todayBtn.addEventListener('click', navigateToToday);
      nextDayBtn.addEventListener('click', navigateToNextDay);
      prevMonthBtn.addEventListener('click', navigateToPreviousMonth);
      nextMonthBtn.addEventListener('click', navigateToNextMonth);
      
      // Event listeners - Analytics
      presetBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          updateAnalyticsDateRange(btn.dataset.range);
          updateAnalytics();
        });
      });
      
      updateAnalyticsBtn.addEventListener('click', () => {
        updateAnalyticsDateRange('custom');
        updateAnalytics();
      });
      
      // Export buttons
      exportJsonBtnEl.addEventListener('click', exportJournalDataToJSON);
      exportCsvBtnEl.addEventListener('click', exportJournalDataToCSV);
      printReportBtnEl.addEventListener('click', () => {
        window.print();
      });
      
      // Event listeners - Journal data management
      exportJournalBtn.addEventListener('click', exportJournalDataToJSON);
      importJournalBtn.addEventListener('click', () => importModalEl.classList.remove('hidden'));
      clearJournalBtn.addEventListener('click', () => clearJournalModalEl.classList.remove('hidden'));
      closeExportModalBtn.addEventListener('click', () => exportModalEl.classList.add('hidden'));
      closeImportModalBtn.addEventListener('click', () => {
        importModalEl.classList.add('hidden');
        importDataEl.value = '';
        importFileEl.value = '';
        importFileNameEl.textContent = 'No file selected';
      });
      closeClearModalBtn.addEventListener('click', () => clearJournalModalEl.classList.add('hidden'));
      cancelClearBtn.addEventListener('click', () => clearJournalModalEl.classList.add('hidden'));
      confirmClearBtn.addEventListener('click', clearAllJournalData);
      copyExportDataBtn.addEventListener('click', copyExportDataToClipboard);
      downloadExportDataBtn.addEventListener('click', downloadExportData);
      
      // Import file handling
      importFileEl.addEventListener('change', processImportFile);
      confirmImportBtn.addEventListener('click', importJournalData);
      
      // Event listeners - Entry deletion
      closeDeleteModalBtn.addEventListener('click', () => deleteModalEl.classList.add('hidden'));
      cancelDeleteBtn.addEventListener('click', () => deleteModalEl.classList.add('hidden'));
      confirmDeleteBtn.addEventListener('click', () => {
        if (currentEntryToDelete) {
          deleteJournalEntry(currentEntryToDelete);
          currentEntryToDelete = null;
          deleteModalEl.classList.add('hidden');
        }
      });
      
      // Close modals when clicking outside
      imageFullscreenModalEl.addEventListener('click', (e) => {
        if (e.target === imageFullscreenModalEl) {
          imageFullscreenModalEl.classList.add('hidden');
        }
      });
      
      document.addEventListener('click', (e) => {
        // Close filter menu when clicking outside
        if (!filterMenuEl.contains(e.target) && e.target !== filterBtnEl) {
          filterMenuEl.classList.add('hidden');
        }
        
        // Close other modals when clicking outside
        if (e.target === settingsModalEl) {
          settingsModalEl.classList.add('hidden');
        }
        if (e.target === deleteModalEl) {
          deleteModalEl.classList.add('hidden');
        }
        if (e.target === exportModalEl) {
          exportModalEl.classList.add('hidden');
        }
        if (e.target === importModalEl) {
          importModalEl.classList.add('hidden');
        }
        if (e.target === clearJournalModalEl) {
          clearJournalModalEl.classList.add('hidden');
        }
      });
    }

    // Start the app
    initialize();
  </script>
</body>
</html>